---
# InstalaciÃ³n y configuraciÃ³n de Squid Proxy transparente

- name: "ğŸ“¦ Instalar Squid"
  ansible.builtin.apt:
    name: squid
    state: present
    update_cache: no
  become: true

- name: "âœ“ Squid instalado"
  ansible.builtin.debug:
    msg: "â†’ Proxy HTTP/HTTPS disponible"

- name: "ğŸ“ Configurar Squid como proxy transparente"
  ansible.builtin.template:
    src: squid.conf.j2
    dest: /etc/squid/squid.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
  become: true

- name: "ğŸ“ Crear directorio de cache"
  ansible.builtin.file:
    path: /var/spool/squid
    state: directory
    owner: proxy
    group: proxy
    mode: '0750'
  become: true

- name: "ğŸ”§ Inicializar cache de Squid"
  ansible.builtin.command: squid -z
  become: true
  changed_when: false
  failed_when: false

- name: "ğŸ”„ Reiniciar Squid"
  ansible.builtin.systemd:
    name: squid
    state: restarted
    enabled: yes
  become: true

- name: "ğŸ›¡ï¸ Configurar iptables para proxy transparente"
  ansible.builtin.shell: |
    # Redirigir trÃ¡fico HTTP (puerto 80) a Squid (puerto 3129)
    iptables -t nat -C PREROUTING -i {{ lan_interface }} -p tcp --dport 80 -j REDIRECT --to-port 3129 2>/dev/null || \
    iptables -t nat -A PREROUTING -i {{ lan_interface }} -p tcp --dport 80 -j REDIRECT --to-port 3129
    
    # Redirigir trÃ¡fico HTTPS (puerto 443) a Squid (puerto 3130)
    iptables -t nat -C PREROUTING -i {{ lan_interface }} -p tcp --dport 443 -j REDIRECT --to-port 3130 2>/dev/null || \
    iptables -t nat -A PREROUTING -i {{ lan_interface }} -p tcp --dport 443 -j REDIRECT --to-port 3130
  become: true
  changed_when: false

- name: "ğŸ’¾ Guardar reglas de iptables"
  ansible.builtin.shell: |
    iptables-save > /etc/iptables/rules.v4
  become: true
  changed_when: true

- name: "âœ… Squid proxy transparente configurado"
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "âœ… Squid Proxy Transparente"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "â†’ Puerto HTTP: 3129 (transparente)"
      - "â†’ Puerto HTTPS: 3130 (transparente)"
      - "â†’ Cache: /var/spool/squid"
      - "â†’ Los clientes NO necesitan configurar nada"
      - "â†’ Juegos LAN funcionan directo"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
