---
# ==========================================================
# CREAR VM UBUNTU EN VMWARE vSphere/ESXi
# ==========================================================
- name: Verificar si la VM ya existe
  community.vmware.vmware_vm_info:
    hostname: "{{ vmware.vcenter_hostname }}"
    username: "{{ vmware.vcenter_username }}"
    password: "{{ vmware.vcenter_password }}"
    port: "{{ vmware.port | default(443) }}"
    validate_certs: false
    vm_name: "{{ vmware.vm_name }}"
  register: vm_info
  failed_when: false

- name: Mostrar estado de la VM si existe
  debug:
    msg: "VM '{{ vmware.vm_name }}' ya existe. Estado: {{ vm_info.virtual_machines[0].power_state | default('unknown') }}"
  when: vm_info.virtual_machines | length > 0

- name: Verificar si existe clave SSH
  stat:
    path: "~/.ssh/id_ed25519.pub"
  register: ssh_key_exists
  delegate_to: localhost

- name: Generar clave SSH si no existe
  openssh_keypair:
    path: "~/.ssh/id_ed25519"
    type: ed25519
    comment: "ansible-ubpc-key"
  delegate_to: localhost
  when: not ssh_key_exists.stat.exists

- name: Leer clave SSH pÃºblica
  slurp:
    src: "~/.ssh/id_ed25519.pub"
  register: ssh_public_key
  delegate_to: localhost

- name: Crear user-data personalizado con clave SSH
  template:
    src: user-data.j2
    dest: "/tmp/user-data-{{ vmware.vm_name }}"
  vars:
    ssh_authorized_key: "{{ ssh_public_key.content | b64decode | trim }}"
  delegate_to: localhost
  when: vm_info.virtual_machines | length == 0

- name: Crear archivo ISO de autoinstall
  community.general.iso_create:
    command: genisoimage
    dest_iso: "/tmp/autoinstall-{{ vmware.vm_name }}.iso"
    files:
      - "/tmp/user-data-{{ vmware.vm_name }}"
      - "{{ role_path }}/files/meta-data"
    vol_ident: "cidata"
  delegate_to: localhost
  when: vm_info.virtual_machines | length == 0

- name: Subir ISO de autoinstall al datastore
  community.vmware.vsphere_copy:
    hostname: "{{ vmware.vcenter_hostname }}"
    username: "{{ vmware.vcenter_username }}"
    password: "{{ vmware.vcenter_password }}"
    validate_certs: false
    src: "/tmp/autoinstall-{{ vmware.vm_name }}.iso"
    datacenter: "{{ vmware.datacenter }}"
    datastore: "{{ vmware.datastore }}"
    path: "autoinstall-{{ vmware.vm_name }}.iso"
  when: vm_info.virtual_machines | length == 0

- name: Crear nueva VM Ubuntu con autoinstall
  community.vmware.vmware_guest:
    hostname: "{{ vmware.vcenter_hostname }}"
    username: "{{ vmware.vcenter_username }}"
    password: "{{ vmware.vcenter_password }}"
    port: "{{ vmware.port | default(443) }}"
    validate_certs: false
    name: "{{ vmware.vm_name }}"
    datacenter: "{{ vmware.datacenter | default('ha-datacenter') }}"
    folder: "{{ vmware.folder | default('/') }}"
    datastore: "{{ vmware.datastore }}"
    guest_id: "{{ vmware.guest_id }}"
    hardware:
      memory_mb: "{{ vmware.memory }}"
      num_cpus: "{{ vmware.cpus }}"
      num_cpu_cores_per_socket: "{{ vmware.cores_per_socket | default(1) }}"
      scsi: paravirtual
    disk:
      - size_gb: "{{ (vmware.disk_size_mb / 1024) | int }}"
        type: thin
        datastore: "{{ vmware.datastore }}"
    networks:
      - name: "{{ vmware.network_name }}"
        device_type: vmxnet3
    cdrom:
      - controller_number: 0
        unit_number: 0
        type: iso
        iso_path: "[{{ vmware.datastore }}] {{ vmware.iso_path }}"
        state: present
      - controller_number: 0
        unit_number: 1
        type: iso
        iso_path: "[{{ vmware.datastore }}] autoinstall-{{ vmware.vm_name }}.iso"
        state: present
    boot_firmware: "{{ vmware.boot_firmware | default('efi') }}"
    secure_boot_enabled: "{{ vmware.secure_boot | default(false) }}"
    state: present
    wait_for_ip_address: false
  when: vm_info.virtual_machines | length == 0
  register: vm_creation

- name: Configurar VM para arranque desde CD/ISO
  community.vmware.vmware_guest_boot_manager:
    hostname: "{{ vmware.vcenter_hostname }}"
    username: "{{ vmware.vcenter_username }}"
    password: "{{ vmware.vcenter_password }}"
    port: "{{ vmware.port | default(443) }}"
    validate_certs: false
    name: "{{ vmware.vm_name }}"
    boot_order:
      - cdrom
      - disk
      - ethernet
      - floppy
  when: vm_creation.changed | default(false)

- name: Encender la VM
  community.vmware.vmware_guest_powerstate:
    hostname: "{{ vmware.vcenter_hostname }}"
    username: "{{ vmware.vcenter_username }}"
    password: "{{ vmware.vcenter_password }}"
    port: "{{ vmware.port | default(443) }}"
    validate_certs: false
    name: "{{ vmware.vm_name }}"
    state: powered-on
  register: vm_power_on

- name: Mostrar informaciÃ³n de la VM creada
  debug:
    msg: |
      ğŸ‰ VM Ubuntu '{{ vmware.vm_name }}' creada exitosamente:
      
      ğŸ“ Especificaciones:
      - Nombre: {{ vmware.vm_name }}
      - SO: Ubuntu 24.04 ({{ vmware.guest_id }})
      - RAM: {{ vmware.memory }}MB
      - CPU: {{ vmware.cpus }} core(s)
      - Disco: {{ (vmware.disk_size_mb / 1024) | int }}GB
      - Red: {{ vmware.network_name }}
      
      ğŸ¤– InstalaciÃ³n automÃ¡tica:
      - ISO Ubuntu: {{ vmware.iso_path }}
      - Autoinstall: Configurado con cloud-init
      - Usuario: ubuntu / ubuntu123
      - SSH: Habilitado automÃ¡ticamente
      - Red IPv6: DHCPv6 automÃ¡tico
      
      â³ La instalaciÃ³n tomarÃ¡ 10-15 minutos automÃ¡ticamente
      ğŸ“‹ PrÃ³ximo paso: Esperar a que obtenga IP y ejecutar configuraciÃ³n

- name: Esperar a que la instalaciÃ³n automÃ¡tica termine y obtenga IP
  community.vmware.vmware_guest_info:
    hostname: "{{ vmware.vcenter_hostname }}"
    username: "{{ vmware.vcenter_username }}"
    password: "{{ vmware.vcenter_password }}"
    port: "{{ vmware.port | default(443) }}"
    validate_certs: false
    name: "{{ vmware.vm_name }}"
  register: vm_facts
  until: vm_facts.instance.ipv4 is defined and vm_facts.instance.ipv4 | length > 0
  retries: 30
  delay: 60
  when: vmware.wait_for_ip | default(true)
  ignore_errors: true

- name: Esperar a que SSH estÃ© disponible
  wait_for:
    host: "{{ vm_facts.instance.ipv4 | first }}"
    port: 22
    timeout: 300
    delay: 30
  when: 
    - vm_facts is defined 
    - vm_facts.instance.ipv4 is defined 
    - vm_facts.instance.ipv4 | length > 0

- name: Agregar VM al inventario dinÃ¡mico para configuraciÃ³n automÃ¡tica
  add_host:
    name: "{{ vmware.vm_name | lower }}"
    groups: nueva_vm_ubpc
    ansible_host: "{{ vm_facts.instance.ipv4 | first }}"
    ansible_user: "ubuntu"
    ansible_ssh_private_key_file: "~/.ssh/id_ed25519"
    ansible_python_interpreter: "/usr/bin/python3"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  when: 
    - vm_facts is defined 
    - vm_facts.instance.ipv4 is defined 
    - vm_facts.instance.ipv4 | length > 0

- name: Mostrar resultado final
  debug:
    msg: |
      ğŸ‰ Â¡VM Ubuntu completamente lista!
      
      ğŸŒ IP asignada: {{ vm_facts.instance.ipv4 | default('Pendiente') }}
      ğŸ‘¤ Usuario: ubuntu / ubuntu123
      ğŸ”‘ SSH: Habilitado y listo
      
      ğŸš€ La VM estÃ¡ lista para configuraciÃ³n automÃ¡tica de servicios
      â­ï¸  Continuando con instalaciÃ³n de servicios IPv6...
  when: vm_facts is defined

- name: Limpiar archivos temporales
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/autoinstall-{{ vmware.vm_name }}.iso"
    - "/tmp/user-data-{{ vmware.vm_name }}"
  delegate_to: localhost
  ignore_errors: true