---
# ConfiguraciÃ³n de Tayga (NAT64)
# Traduce trÃ¡fico IPv6 â†’ IPv4 para salida a internet

- name: "ðŸ“¦ Instalar Tayga"
  ansible.builtin.apt:
    name: tayga
    state: present
    update_cache: yes
  become: true

- name: "âœ“ Tayga instalado"
  ansible.builtin.debug:
    msg: "â†’ Tayga NAT64 instalado"

- name: "ðŸ“ Configurar Tayga"
  ansible.builtin.copy:
    content: |
      # ConfiguraciÃ³n de Tayga NAT64
      
      # Prefijo IPv6 para NAT64 (debe coincidir con DNS64)
      prefix 64:ff9b::/96
      
      # Pool de IPs IPv4 dinÃ¡micas para traducciÃ³n
      dynamic-pool 192.168.255.0/24
      
      # DirecciÃ³n IPv4 del tÃºnel
      ipv4-addr 192.168.255.1
      
      # DirecciÃ³n IPv6 del tÃºnel (requerida para IPs privadas)
      ipv6-addr 2025:db8:10::ffff
      
      # Interfaz de tÃºnel
      tun-device nat64
      
      # Directorio de datos
      data-dir /var/spool/tayga
    dest: /etc/tayga.conf
    owner: root
    group: root
    mode: '0644'
  become: true

- name: "âœ“ ConfiguraciÃ³n de Tayga creada"
  ansible.builtin.debug:
    msg: "â†’ Archivo: /etc/tayga.conf"

- name: "ðŸ‘¤ Verificar si usuario tayga existe"
  ansible.builtin.command: id tayga
  register: tayga_user_check
  failed_when: false
  changed_when: false
  become: true

- name: "ðŸ“ Crear directorio de datos de Tayga"
  ansible.builtin.file:
    path: /var/spool/tayga
    state: directory
    owner: "{{ 'tayga' if tayga_user_check.rc == 0 else 'root' }}"
    group: "{{ 'tayga' if tayga_user_check.rc == 0 else 'root' }}"
    mode: '0755'
  become: true

- name: "ðŸ”§ Crear tÃºnel de Tayga"
  ansible.builtin.command: tayga --mktun
  become: true
  register: tayga_mktun
  failed_when: false
  changed_when: tayga_mktun.rc == 0

- name: "ðŸ”Œ Levantar interfaz nat64"
  ansible.builtin.command: ip link set nat64 up
  become: true
  changed_when: true

- name: "ðŸŒ Configurar IP IPv4 en nat64"
  ansible.builtin.command: ip addr add 192.168.255.1 dev nat64
  become: true
  register: ipv4_add
  failed_when: false
  changed_when: ipv4_add.rc == 0

- name: "ðŸŒ Configurar IP IPv6 en nat64"
  ansible.builtin.command: ip addr add 2025:db8:10::ffff dev nat64
  become: true
  register: ipv6_add
  failed_when: false
  changed_when: ipv6_add.rc == 0

- name: "ðŸ›£ï¸  Agregar ruta IPv4 para NAT64"
  ansible.builtin.command: ip route add 192.168.255.0/24 dev nat64
  become: true
  register: route_ipv4
  failed_when: false
  changed_when: route_ipv4.rc == 0

- name: "ðŸ›£ï¸  Agregar ruta IPv6 para NAT64"
  ansible.builtin.command: ip route add 64:ff9b::/96 dev nat64
  become: true
  register: route_ipv6
  failed_when: false
  changed_when: route_ipv6.rc == 0

- name: "ðŸš€ Iniciar Tayga"
  ansible.builtin.command: tayga
  become: true
  register: tayga_start
  failed_when: false
  changed_when: tayga_start.rc == 0

- name: "ðŸ›¡ï¸  Configurar iptables para Tayga"
  ansible.builtin.shell: |
    # NAT para el pool de Tayga
    iptables -t nat -C POSTROUTING -s 192.168.255.0/24 -o {{ wan_interface }} -j MASQUERADE 2>/dev/null || \
    iptables -t nat -A POSTROUTING -s 192.168.255.0/24 -o {{ wan_interface }} -j MASQUERADE
    
    # FORWARD para nat64
    iptables -C FORWARD -i nat64 -o {{ wan_interface }} -j ACCEPT 2>/dev/null || \
    iptables -A FORWARD -i nat64 -o {{ wan_interface }} -j ACCEPT
    
    iptables -C FORWARD -i {{ wan_interface }} -o nat64 -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || \
    iptables -A FORWARD -i {{ wan_interface }} -o nat64 -m state --state RELATED,ESTABLISHED -j ACCEPT
    
    # Guardar reglas
    iptables-save > /etc/iptables/rules.v4
  become: true
  changed_when: false

- name: "âœ“ iptables configurado para Tayga"
  ansible.builtin.debug:
    msg: "â†’ Reglas de NAT y FORWARD agregadas"

- name: "ðŸ“ Crear script de inicio de Tayga"
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Script para iniciar Tayga NAT64 al arrancar
      
      # Crear tÃºnel si no existe
      tayga --mktun 2>/dev/null || true
      
      # Levantar interfaz
      ip link set nat64 up
      
      # Configurar IPs
      ip addr add 192.168.255.1 dev nat64 2>/dev/null || true
      ip addr add 2025:db8:10::ffff dev nat64 2>/dev/null || true
      
      # Agregar rutas
      ip route add 192.168.255.0/24 dev nat64 2>/dev/null || true
      ip route add 64:ff9b::/96 dev nat64 2>/dev/null || true
      
      # Iniciar Tayga
      tayga 2>/dev/null || true
      
      echo "Tayga NAT64 iniciado"
    dest: /usr/local/bin/start-tayga.sh
    owner: root
    group: root
    mode: '0755'
  become: true

- name: "ðŸš€ Crear servicio systemd para Tayga"
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Tayga NAT64
      After=network.target
      
      [Service]
      Type=forking
      ExecStart=/usr/local/bin/start-tayga.sh
      RemainAfterExit=yes
      
      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/tayga-nat64.service
    owner: root
    group: root
    mode: '0644'
  become: true

- name: "ðŸ”„ Recargar systemd"
  ansible.builtin.systemd:
    daemon_reload: yes
  become: true

- name: "âœ… Habilitar servicio Tayga"
  ansible.builtin.systemd:
    name: tayga-nat64
    enabled: yes
  become: true

- name: "âœ“ Tayga NAT64 configurado"
  ansible.builtin.debug:
    msg:
      - "â†’ Tayga estÃ¡ corriendo"
      - "â†’ Interfaz: nat64"
      - "â†’ Prefijo NAT64: 64:ff9b::/96"
      - "â†’ Pool IPv4: 192.168.255.0/24"
      - "â†’ Las VMs IPv6-only pueden acceder a internet IPv4"
