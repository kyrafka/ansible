---
# ConfiguraciÃ³n de NAT64 con iptables (mÃ©todo simple)
# Traduce IPv6 â†’ IPv4 para salida a internet

- name: "ğŸ” Verificar si el servidor tiene IPv4 en WAN"
  ansible.builtin.shell: ip -4 addr show {{ wan_interface }} | grep "inet "
  register: ipv4_check
  changed_when: false
  become: true

- name: "âœ“ IPv4 detectada en WAN"
  ansible.builtin.debug:
    msg: "â†’ {{ ipv4_check.stdout_lines }}"

- name: "ğŸ›¡ï¸  Configurar iptables para NAT (IPv6 â†’ IPv4)"
  ansible.builtin.shell: |
    # Limpiar reglas anteriores
    iptables -t nat -F POSTROUTING 2>/dev/null || true
    
    # Permitir forwarding de paquetes
    iptables -A FORWARD -i {{ lan_interface }} -o {{ wan_interface }} -j ACCEPT
    iptables -A FORWARD -i {{ wan_interface }} -o {{ lan_interface }} -m state --state RELATED,ESTABLISHED -j ACCEPT
    
    # NAT para que las VMs salgan con la IP del servidor
    iptables -t nat -A POSTROUTING -o {{ wan_interface }} -j MASQUERADE
    
    # Guardar reglas
    mkdir -p /etc/iptables
    iptables-save > /etc/iptables/rules.v4
  become: true
  changed_when: true

- name: "âœ“ NAT configurado"
  ansible.builtin.debug:
    msg:
      - "â†’ Las VMs con IPv6 pueden salir a internet"
      - "â†’ El servidor traduce y hace NAT a IPv4"
      - "â†’ Interfaz salida: {{ wan_interface }}"

- name: "ğŸ“¦ Instalar iptables-persistent para guardar reglas"
  ansible.builtin.apt:
    name: iptables-persistent
    state: present
  become: true
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: "ğŸ’¾ Guardar reglas de iptables permanentemente"
  ansible.builtin.shell: |
    netfilter-persistent save
  become: true
  changed_when: true

- name: "âœ“ Reglas guardadas"
  ansible.builtin.debug:
    msg: "â†’ Las reglas se aplicarÃ¡n automÃ¡ticamente al reiniciar"
