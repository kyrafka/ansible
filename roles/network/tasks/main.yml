---
# ConfiguraciÃ³n de red para servidor con 2 interfaces

- name: "ğŸ” Detectando interfaces de red"
  ansible.builtin.set_fact:
    wan_interface: "ens33"
    lan_interface: "ens34"

- name: "ğŸ“‹ Interfaces detectadas"
  ansible.builtin.debug:
    msg:
      - "â†’ Interfaz WAN: {{ wan_interface }} (internet)"
      - "â†’ Interfaz LAN: {{ lan_interface }} (red interna IPv6)"

- name: "ğŸ§¹ Eliminar solo configuraciÃ³n de {{ lan_interface }}"
  ansible.builtin.file:
    path: "/etc/netplan/99-{{ lan_interface }}-ipv6.yaml"
    state: absent
  become: true
  ignore_errors: yes

- name: "ğŸ§¹ Limpiar IPs SLAAC en {{ lan_interface }} (solo scope global dynamic)"
  ansible.builtin.shell: |
    # Solo eliminar IPs dinÃ¡micas (SLAAC), no la fija
    ip -6 addr show dev {{ lan_interface }} scope global dynamic | grep 'inet6' | awk '{print $2}' | while read addr; do
      ip -6 addr del $addr dev {{ lan_interface }} 2>/dev/null || true
    done
  become: true
  changed_when: false
  ignore_errors: yes

- name: "ğŸ“ Creando configuraciÃ³n netplan limpia para {{ lan_interface }}"
  ansible.builtin.template:
    src: netplan-ens34.yaml.j2
    dest: /etc/netplan/99-ens34-ipv6.yaml
    owner: root
    group: root
    mode: '0600'
  become: true

- name: "âœ“ ConfiguraciÃ³n netplan creada"
  ansible.builtin.debug:
    msg: "â†’ Archivo: /etc/netplan/99-ens34-ipv6.yaml"

- name: "ğŸ”„ Aplicando configuraciÃ³n de netplan"
  ansible.builtin.command: netplan apply
  become: true
  register: netplan_result

- name: "âœ“ Netplan aplicado"
  ansible.builtin.debug:
    msg: "â†’ IPv6 configurada en {{ lan_interface }}: 2025:db8:10::2/64"

- name: "ğŸ”€ Habilitando IP forwarding IPv4"
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes
  become: true

- name: "âœ“ IPv4 forwarding habilitado"
  ansible.builtin.debug:
    msg: "â†’ net.ipv4.ip_forward = 1"

- name: "ğŸ”€ Habilitando IP forwarding IPv6"
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    state: present
    reload: yes
  become: true

- name: "âœ“ IPv6 forwarding habilitado"
  ansible.builtin.debug:
    msg: "â†’ net.ipv6.conf.all.forwarding = 1 (el servidor ahora es un router)"

- name: "ğŸš« Desactivar SLAAC en interfaz LAN ({{ lan_interface }})"
  ansible.posix.sysctl:
    name: "net.ipv6.conf.{{ lan_interface }}.autoconf"
    value: '0'
    state: present
    reload: yes
  become: true

- name: "âœ… Permitir Router Advertisements en interfaz LAN ({{ lan_interface }})"
  ansible.posix.sysctl:
    name: "net.ipv6.conf.{{ lan_interface }}.accept_ra"
    value: '2'
    state: present
    reload: yes
  become: true

- name: "âœ“ ConfiguraciÃ³n de RA en {{ lan_interface }}"
  ansible.builtin.debug:
    msg: 
      - "â†’ SLAAC desactivado: No generarÃ¡ IPs automÃ¡ticas basadas en MAC"
      - "â†’ Accept RA habilitado: RecibirÃ¡ informaciÃ³n de routing de otros routers"
      - "â†’ UsarÃ¡ IP fija: 2025:db8:10::2"

- name: "ğŸ”„ Reiniciar interfaz {{ lan_interface }} para aplicar cambios"
  ansible.builtin.shell: |
    ip link set {{ lan_interface }} down
    sleep 2
    ip link set {{ lan_interface }} up
  become: true
  changed_when: true

- name: "â³ Esperar a que la interfaz estÃ© lista"
  ansible.builtin.pause:
    seconds: 5

- name: "âœ“ Interfaz {{ lan_interface }} reiniciada"
  ansible.builtin.debug:
    msg: "â†’ IPs SLAAC antiguas eliminadas, solo quedarÃ¡ la IP fija"

- name: "ğŸ“ Creando directorio para reglas de iptables"
  ansible.builtin.file:
    path: /etc/iptables
    state: directory
    mode: '0755'
  become: true

- name: "ğŸ§¹ Limpiar reglas NAT66 antiguas"
  ansible.builtin.shell: |
    # Eliminar reglas antiguas con SNAT incorrectas
    ip6tables -t nat -D POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j SNAT --to ::/0 2>/dev/null || true
    # Eliminar reglas MASQUERADE antiguas para reconfigurar
    ip6tables -t nat -D POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j MASQUERADE 2>/dev/null || true
  become: true
  changed_when: false
  ignore_errors: yes

- name: "ğŸ›¡ï¸  Configurando NAT66 con MASQUERADE (IPv6 â†’ Internet)"
  ansible.builtin.shell: |
    # Verificar si ya existe la regla correcta
    ip6tables -t nat -C POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j MASQUERADE 2>/dev/null || \
    # Si no existe, agregarla
    ip6tables -t nat -A POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j MASQUERADE
  become: true
  changed_when: false

- name: "ğŸ”€ Configurando reglas de FORWARD para NAT66"
  ansible.builtin.shell: |
    # Permitir trÃ¡fico de LAN a WAN
    ip6tables -C FORWARD -i {{ lan_interface }} -o {{ wan_interface }} -j ACCEPT 2>/dev/null || \
    ip6tables -A FORWARD -i {{ lan_interface }} -o {{ wan_interface }} -j ACCEPT
    
    # Permitir trÃ¡fico de retorno (established/related)
    ip6tables -C FORWARD -i {{ wan_interface }} -o {{ lan_interface }} -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || \
    ip6tables -A FORWARD -i {{ wan_interface }} -o {{ lan_interface }} -m state --state RELATED,ESTABLISHED -j ACCEPT
  become: true
  changed_when: false

- name: "âœ“ NAT66 configurado correctamente"
  ansible.builtin.debug:
    msg:
      - "â†’ Red origen: 2025:db8:10::/64"
      - "â†’ Interfaz salida: {{ wan_interface }}"
      - "â†’ MÃ©todo: MASQUERADE (dinÃ¡mico)"
      - "â†’ Las VMs podrÃ¡n salir a internet a travÃ©s del servidor"

- name: "ğŸ’¾ Guardando reglas de iptables"
  ansible.builtin.shell: |
    ip6tables-save > /etc/iptables/rules.v6
  become: true
  args:
    creates: /etc/iptables/rules.v6

- name: "âœ“ Reglas guardadas"
  ansible.builtin.debug:
    msg: "â†’ Archivo: /etc/iptables/rules.v6"

- name: "ğŸ“¡ Configurar Router Advertisements (radvd)"
  block:
    - ansible.builtin.include_tasks: radvd.yml
  rescue:
    - name: "âŒ Error en radvd"
      ansible.builtin.debug:
        msg: "Error al configurar radvd: {{ ansible_failed_result }}"
    - name: "âš ï¸ Continuando sin radvd"
      ansible.builtin.debug:
        msg: "radvd no se pudo configurar, pero continuamos"
  tags: [network, radvd]

- name: "ğŸŒ Configurar NAT64 con Tayga (IPv6 â†’ IPv4)"
  block:
    - ansible.builtin.include_tasks: tayga.yml
  rescue:
    - name: "âŒ Error en Tayga"
      ansible.builtin.debug:
        msg: "Error al configurar Tayga: {{ ansible_failed_result }}"
    - name: "âš ï¸ Continuando sin Tayga"
      ansible.builtin.debug:
        msg: "Tayga no se pudo configurar, pero continuamos"
  tags: [network, nat64, tayga]

- name: "ğŸŒ Configurar Squid Proxy (HTTP/HTTPS sobre IPv6)"
  block:
    - ansible.builtin.include_tasks: squid-proxy.yml
  rescue:
    - name: "âŒ Error en Squid"
      ansible.builtin.debug:
        msg: "Error al configurar Squid: {{ ansible_failed_result }}"
    - name: "âš ï¸ Continuando sin Squid"
      ansible.builtin.debug:
        msg: "Squid no se pudo configurar, pero continuamos"
  tags: [network, proxy, squid]

- name: Verificar configuraciÃ³n de red
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ConfiguraciÃ³n de red aplicada"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "WAN ({{ wan_interface }}): IPv4 DHCP (internet) - ens33 (VM Network)"
      - "LAN ({{ lan_interface }}): IPv6 2025:db8:10::/64 - ens34 (M_vm's)"
      - "IP del servidor: 2025:db8:10::2"
      - "Forwarding: Habilitado"
      - "NAT66: Configurado"
      - "Router Advertisements: Activo (radvd)"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
