---
# ConfiguraciÃ³n de red para servidor con 2 interfaces

- name: "ğŸ” Detectando interfaces de red"
  ansible.builtin.set_fact:
    wan_interface: "ens33"
    lan_interface: "ens34"

- name: "ğŸ“‹ Interfaces detectadas"
  ansible.builtin.debug:
    msg:
      - "â†’ Interfaz WAN: {{ wan_interface }} (internet)"
      - "â†’ Interfaz LAN: {{ lan_interface }} (red interna IPv6)"

- name: "ğŸ“ Creando configuraciÃ³n netplan para {{ lan_interface }}"
  ansible.builtin.template:
    src: netplan-ens34.yaml.j2
    dest: /etc/netplan/99-ens34-ipv6.yaml
    owner: root
    group: root
    mode: '0600'
  become: true

- name: "âœ“ ConfiguraciÃ³n netplan creada"
  ansible.builtin.debug:
    msg: "â†’ Archivo: /etc/netplan/99-ens34-ipv6.yaml"

- name: "ğŸ”„ Aplicando configuraciÃ³n de netplan"
  ansible.builtin.command: netplan apply
  become: true
  register: netplan_result

- name: "âœ“ Netplan aplicado"
  ansible.builtin.debug:
    msg: "â†’ IPv6 configurada en {{ lan_interface }}: 2025:db8:10::2/64"

- name: "ğŸ”€ Habilitando IP forwarding IPv4"
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes
  become: true

- name: "âœ“ IPv4 forwarding habilitado"
  ansible.builtin.debug:
    msg: "â†’ net.ipv4.ip_forward = 1"

- name: "ğŸ”€ Habilitando IP forwarding IPv6"
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    state: present
    reload: yes
  become: true

- name: "âœ“ IPv6 forwarding habilitado"
  ansible.builtin.debug:
    msg: "â†’ net.ipv6.conf.all.forwarding = 1 (el servidor ahora es un router)"

- name: "ğŸ“ Creando directorio para reglas de iptables"
  ansible.builtin.file:
    path: /etc/iptables
    state: directory
    mode: '0755'
  become: true

- name: "ğŸ›¡ï¸  Configurando NAT66 (IPv6 â†’ IPv4)"
  ansible.builtin.shell: |
    ip6tables -t nat -C POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j MASQUERADE 2>/dev/null || \
    ip6tables -t nat -A POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j MASQUERADE
  become: true
  changed_when: false

- name: "âœ“ NAT66 configurado"
  ansible.builtin.debug:
    msg:
      - "â†’ Red origen: 2025:db8:10::/64"
      - "â†’ Interfaz salida: {{ wan_interface }}"
      - "â†’ Las VMs podrÃ¡n salir a internet a travÃ©s del servidor"

- name: "ğŸ’¾ Guardando reglas de iptables"
  ansible.builtin.shell: |
    ip6tables-save > /etc/iptables/rules.v6
  become: true
  args:
    creates: /etc/iptables/rules.v6

- name: "âœ“ Reglas guardadas"
  ansible.builtin.debug:
    msg: "â†’ Archivo: /etc/iptables/rules.v6"

- name: "ğŸ“¡ Configurar Router Advertisements (radvd)"
  ansible.builtin.include_tasks: radvd.yml
  tags: [network, radvd]

- name: "ğŸŒ Configurar NAT64 (IPv6 â†’ IPv4)"
  ansible.builtin.include_tasks: nat64.yml
  tags: [network, nat64]

- name: Verificar configuraciÃ³n de red
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ConfiguraciÃ³n de red aplicada"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "WAN ({{ wan_interface }}): IPv4 DHCP (internet)"
      - "LAN ({{ lan_interface }}): IPv6 2025:db8:10::/64"
      - "IP del servidor: 2025:db8:10::2"
      - "Forwarding: Habilitado"
      - "NAT66: Configurado"
      - "Router Advertisements: Activo (radvd)"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
