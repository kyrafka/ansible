---
# ConfiguraciÃ³n de red para servidor con 2 interfaces

- name: "ğŸ” Detectando interfaces de red"
  ansible.builtin.set_fact:
    wan_interface: "ens33"
    lan_interface: "ens34"

- name: "ğŸ“‹ Interfaces detectadas"
  ansible.builtin.debug:
    msg:
      - "â†’ Interfaz WAN: {{ wan_interface }} (internet)"
      - "â†’ Interfaz LAN: {{ lan_interface }} (red interna IPv6)"

- name: "ğŸ§¹ Eliminar solo configuraciÃ³n de {{ lan_interface }}"
  ansible.builtin.file:
    path: "/etc/netplan/99-{{ lan_interface }}-ipv6.yaml"
    state: absent
  become: true
  ignore_errors: yes

- name: "ğŸ§¹ Limpiar IPs SLAAC en {{ lan_interface }} (solo scope global dynamic)"
  ansible.builtin.shell: |
    # Solo eliminar IPs dinÃ¡micas (SLAAC), no la fija
    ip -6 addr show dev {{ lan_interface }} scope global dynamic | grep 'inet6' | awk '{print $2}' | while read addr; do
      ip -6 addr del $addr dev {{ lan_interface }} 2>/dev/null || true
    done
  become: true
  changed_when: false
  ignore_errors: yes

- name: "ğŸ“ Creando configuraciÃ³n netplan completa (ens33 + ens34)"
  ansible.builtin.copy:
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          ens33:
            # WAN - Internet
            dhcp4: true
            dhcp6: false
            nameservers:
              addresses:
                - 8.8.8.8
                - 8.8.4.4
                - 2001:4860:4860::8888
          ens34:
            # LAN - Red interna IPv6
            dhcp4: false
            dhcp6: false
            accept-ra: false
            ipv6-privacy: false
            addresses:
              - 2025:db8:10::1/64
              - 2025:db8:10::2/64
    dest: /etc/netplan/99-server-network.yaml
    owner: root
    group: root
    mode: '0600'
  become: true

- name: "âœ“ ConfiguraciÃ³n netplan creada"
  ansible.builtin.debug:
    msg: "â†’ Archivo: /etc/netplan/99-server-network.yaml (ens33 + ens34 + DNS)"

- name: "ğŸ”„ Aplicando configuraciÃ³n de netplan"
  ansible.builtin.command: netplan apply
  become: true
  register: netplan_result

- name: "âœ“ Netplan aplicado"
  ansible.builtin.debug:
    msg: "â†’ IPv6 configurada en {{ lan_interface }}: 2025:db8:10::2/64"

- name: "ğŸŒ Configurar DNS del servidor (para que pueda resolver nombres)"
  ansible.builtin.file:
    path: /etc/systemd/resolved.conf.d
    state: directory
    mode: '0755'
  become: true

- name: "ğŸŒ Agregar servidores DNS pÃºblicos"
  ansible.builtin.copy:
    content: |
      [Resolve]
      DNS=8.8.8.8
      DNS=8.8.4.4
      DNS=2001:4860:4860::8888
      DNS=2001:4860:4860::8844
      FallbackDNS=1.1.1.1
      FallbackDNS=1.0.0.1
    dest: /etc/systemd/resolved.conf.d/dns.conf
    owner: root
    group: root
    mode: '0644'
  become: true

- name: "ğŸ”„ Reiniciar systemd-resolved"
  ansible.builtin.systemd:
    name: systemd-resolved
    state: restarted
  become: true

- name: "âœ“ DNS del servidor configurado"
  ansible.builtin.debug:
    msg:
      - "â†’ El servidor ahora puede resolver nombres"
      - "â†’ DNS: 8.8.8.8, 8.8.4.4 (Google)"
      - "â†’ Esto es necesario para que BIND9 funcione correctamente"

- name: "ğŸ”€ Habilitando IP forwarding IPv4"
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes
  become: true

- name: "âœ“ IPv4 forwarding habilitado"
  ansible.builtin.debug:
    msg: "â†’ net.ipv4.ip_forward = 1"

- name: "ğŸ”€ Habilitando IP forwarding IPv6"
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    state: present
    reload: yes
  become: true

- name: "âœ“ IPv6 forwarding habilitado"
  ansible.builtin.debug:
    msg: "â†’ net.ipv6.conf.all.forwarding = 1 (el servidor ahora es un router)"

- name: "ğŸš« Desactivar SLAAC en interfaz LAN ({{ lan_interface }})"
  ansible.posix.sysctl:
    name: "net.ipv6.conf.{{ lan_interface }}.autoconf"
    value: '0'
    state: present
    reload: yes
  become: true

- name: "âœ… Permitir Router Advertisements en interfaz LAN ({{ lan_interface }})"
  ansible.posix.sysctl:
    name: "net.ipv6.conf.{{ lan_interface }}.accept_ra"
    value: '2'
    state: present
    reload: yes
  become: true

- name: "âœ“ ConfiguraciÃ³n de RA en {{ lan_interface }}"
  ansible.builtin.debug:
    msg: 
      - "â†’ SLAAC desactivado: No generarÃ¡ IPs automÃ¡ticas basadas en MAC"
      - "â†’ Accept RA habilitado: RecibirÃ¡ informaciÃ³n de routing de otros routers"
      - "â†’ UsarÃ¡ IP fija: 2025:db8:10::2"

- name: "ğŸ”„ Reiniciar interfaz {{ lan_interface }} para aplicar cambios"
  ansible.builtin.shell: |
    ip link set {{ lan_interface }} down
    sleep 2
    ip link set {{ lan_interface }} up
  become: true
  changed_when: true

- name: "â³ Esperar a que la interfaz estÃ© lista"
  ansible.builtin.pause:
    seconds: 5

- name: "âœ“ Interfaz {{ lan_interface }} reiniciada"
  ansible.builtin.debug:
    msg: "â†’ IPs SLAAC antiguas eliminadas, solo quedarÃ¡ la IP fija"

- name: "ğŸ›¡ï¸ Configurar NAT y persistencia de reglas iptables"
  ansible.builtin.include_tasks: iptables-persistent.yml
  tags: [network, iptables, nat]

- name: "ğŸ“¡ Configurar Router Advertisements (radvd)"
  block:
    - ansible.builtin.include_tasks: radvd.yml
  rescue:
    - name: "âŒ Error en radvd"
      ansible.builtin.debug:
        msg: "Error al configurar radvd: {{ ansible_failed_result }}"
    - name: "âš ï¸ Continuando sin radvd"
      ansible.builtin.debug:
        msg: "radvd no se pudo configurar, pero continuamos"
  tags: [network, radvd]

- name: "ğŸŒ Configurar NAT64 (Tayga) para acceso a internet IPv4"
  ansible.builtin.include_role:
    name: nat64_tayga
  tags: [network, nat64, tayga]

- name: "â­ï¸  Omitiendo Squid Proxy - No necesario para configuraciÃ³n bÃ¡sica"
  ansible.builtin.debug:
    msg: "â†’ Squid omitido (solo necesario para proxy HTTP)"
  tags: [network, proxy, squid]

- name: Verificar configuraciÃ³n de red
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "ConfiguraciÃ³n de red aplicada"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "WAN ({{ wan_interface }}): IPv4 DHCP (internet) - ens33 (VM Network)"
      - "LAN ({{ lan_interface }}): IPv6 2025:db8:10::/64 - ens34 (M_vm's)"
      - "IP del servidor: 2025:db8:10::2"
      - "Forwarding: Habilitado"
      - "NAT66: Configurado"
      - "Router Advertisements: Activo (radvd)"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
