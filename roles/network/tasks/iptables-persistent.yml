---
# ConfiguraciÃ³n de persistencia de reglas iptables/ip6tables

- name: "ğŸ“¦ Instalar iptables-persistent"
  ansible.builtin.apt:
    name: 
      - iptables-persistent
      - netfilter-persistent
    state: present
    update_cache: no
  become: true

- name: "âœ“ iptables-persistent instalado"
  ansible.builtin.debug:
    msg: "â†’ Las reglas de firewall ahora persistirÃ¡n despuÃ©s de reiniciar"

- name: "ğŸ“ Crear directorio para reglas de iptables"
  ansible.builtin.file:
    path: /etc/iptables
    state: directory
    mode: '0755'
  become: true

- name: "ğŸ§¹ Limpiar reglas antiguas de NAT (IPv4)"
  ansible.builtin.shell: |
    # Limpiar reglas antiguas
    iptables -t nat -F POSTROUTING 2>/dev/null || true
  become: true
  changed_when: false

- name: "ğŸ›¡ï¸ Configurar NAT para IPv4 (MASQUERADE)"
  ansible.builtin.shell: |
    # Verificar si ya existe la regla
    iptables -t nat -C POSTROUTING -o {{ wan_interface }} -j MASQUERADE 2>/dev/null || \
    # Si no existe, agregarla
    iptables -t nat -A POSTROUTING -o {{ wan_interface }} -j MASQUERADE
  become: true
  changed_when: false

- name: "ğŸ”€ Configurar reglas de FORWARD para IPv4"
  ansible.builtin.shell: |
    # Permitir trÃ¡fico de LAN a WAN
    iptables -C FORWARD -i {{ lan_interface }} -o {{ wan_interface }} -j ACCEPT 2>/dev/null || \
    iptables -A FORWARD -i {{ lan_interface }} -o {{ wan_interface }} -j ACCEPT
    
    # Permitir trÃ¡fico de retorno
    iptables -C FORWARD -i {{ wan_interface }} -o {{ lan_interface }} -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || \
    iptables -A FORWARD -i {{ wan_interface }} -o {{ lan_interface }} -m state --state RELATED,ESTABLISHED -j ACCEPT
  become: true
  changed_when: false

- name: "âœ“ NAT IPv4 configurado"
  ansible.builtin.debug:
    msg:
      - "â†’ Interfaz salida: {{ wan_interface }}"
      - "â†’ MÃ©todo: MASQUERADE (dinÃ¡mico)"

- name: "ğŸ§¹ Limpiar reglas antiguas de NAT66 (IPv6)"
  ansible.builtin.shell: |
    # Eliminar reglas antiguas con SNAT incorrectas
    ip6tables -t nat -D POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j SNAT --to ::/0 2>/dev/null || true
    # Limpiar todas las reglas de POSTROUTING para reconfigurar
    ip6tables -t nat -F POSTROUTING 2>/dev/null || true
  become: true
  changed_when: false

- name: "ğŸ›¡ï¸ Configurar NAT66 para IPv6 (MASQUERADE)"
  ansible.builtin.shell: |
    # Verificar si ya existe la regla
    ip6tables -t nat -C POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j MASQUERADE 2>/dev/null || \
    # Si no existe, agregarla
    ip6tables -t nat -A POSTROUTING -s 2025:db8:10::/64 -o {{ wan_interface }} -j MASQUERADE
  become: true
  changed_when: false

- name: "ğŸ”€ Configurar reglas de FORWARD para IPv6"
  ansible.builtin.shell: |
    # Permitir trÃ¡fico de LAN a WAN
    ip6tables -C FORWARD -i {{ lan_interface }} -o {{ wan_interface }} -j ACCEPT 2>/dev/null || \
    ip6tables -A FORWARD -i {{ lan_interface }} -o {{ wan_interface }} -j ACCEPT
    
    # Permitir trÃ¡fico de retorno
    ip6tables -C FORWARD -i {{ wan_interface }} -o {{ lan_interface }} -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || \
    ip6tables -A FORWARD -i {{ wan_interface }} -o {{ lan_interface }} -m state --state RELATED,ESTABLISHED -j ACCEPT
  become: true
  changed_when: false

- name: "âœ“ NAT66 IPv6 configurado"
  ansible.builtin.debug:
    msg:
      - "â†’ Red origen: 2025:db8:10::/64"
      - "â†’ Interfaz salida: {{ wan_interface }}"
      - "â†’ MÃ©todo: MASQUERADE (dinÃ¡mico)"

- name: "ğŸ’¾ Guardar reglas de iptables IPv4"
  ansible.builtin.shell: |
    iptables-save > /etc/iptables/rules.v4
    cp /etc/iptables/rules.v4 /etc/iptables/rules.v4.backup
  become: true
  changed_when: true

- name: "ğŸ’¾ Guardar reglas de ip6tables IPv6"
  ansible.builtin.shell: |
    ip6tables-save > /etc/iptables/rules.v6
    cp /etc/iptables/rules.v6 /etc/iptables/rules.v6.backup
  become: true
  changed_when: true

- name: "âœ“ Reglas guardadas"
  ansible.builtin.debug:
    msg:
      - "â†’ IPv4: /etc/iptables/rules.v4"
      - "â†’ IPv6: /etc/iptables/rules.v6"
      - "â†’ Backups creados"

- name: "ğŸ”— Crear enlaces simbÃ³licos para netfilter-persistent"
  ansible.builtin.file:
    src: "/etc/iptables/rules.{{ item }}"
    dest: "/etc/iptables/rules.{{ item }}"
    state: file
  become: true
  loop:
    - v4
    - v6
  ignore_errors: yes

- name: "ğŸ”„ Habilitar netfilter-persistent"
  ansible.builtin.systemd:
    name: netfilter-persistent
    enabled: yes
    state: started
  become: true

- name: "âœ“ Persistencia de reglas habilitada"
  ansible.builtin.debug:
    msg:
      - "â†’ Las reglas de firewall se cargarÃ¡n automÃ¡ticamente al iniciar"
      - "â†’ Servicio: netfilter-persistent"

- name: "ğŸ” Verificar reglas activas de NAT IPv4"
  ansible.builtin.command: iptables -t nat -L POSTROUTING -n -v
  register: nat_rules_v4
  become: true
  changed_when: false

- name: "ğŸ“‹ Reglas NAT IPv4 activas"
  ansible.builtin.debug:
    msg: "{{ nat_rules_v4.stdout_lines }}"

- name: "ğŸ” Verificar reglas activas de NAT66 IPv6"
  ansible.builtin.command: ip6tables -t nat -L POSTROUTING -n -v
  register: nat_rules_v6
  become: true
  changed_when: false

- name: "ğŸ“‹ Reglas NAT66 IPv6 activas"
  ansible.builtin.debug:
    msg: "{{ nat_rules_v6.stdout_lines }}"

- name: "âœ… ConfiguraciÃ³n de NAT completada"
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "âœ… NAT configurado correctamente"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "â†’ IPv4: MASQUERADE en {{ wan_interface }}"
      - "â†’ IPv6: MASQUERADE para 2025:db8:10::/64"
      - "â†’ Forwarding: Habilitado"
      - "â†’ Persistencia: Activa (sobrevive reinicios)"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "Las VMs ahora deberÃ­an tener acceso a internet"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
