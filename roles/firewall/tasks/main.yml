---
# Configuración avanzada del firewall con fail2ban y monitoreo

- name: "Instalar firewall y herramientas de seguridad"
  apt:
    name:
      - ufw
      - fail2ban
      - iptables-persistent
      - netfilter-persistent
    state: present
    update_cache: yes
  tags: firewall

- name: "Asegurar que ufw esté en el PATH"
  ansible.builtin.set_fact:
    ansible_env:
      PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  tags: firewall

- name: "Resetear configuración UFW"
  ufw:
    state: reset
  tags: firewall

- name: "Configurar políticas por defecto"
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }
  tags: firewall

- name: "Permitir SSH con limitación de conexiones"
  ufw:
    rule: limit
    port: '22'
    proto: tcp
    comment: "SSH con rate limiting"
  tags: firewall

- name: "Permitir servicios del proyecto"
  ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  loop:
    - { port: '53', proto: 'tcp', comment: 'DNS TCP' }
    - { port: '53', proto: 'udp', comment: 'DNS UDP' }
    - { port: '547', proto: 'udp', comment: 'DHCPv6 Server' }
    - { port: '546', proto: 'udp', comment: 'DHCPv6 Client' }
  tags: firewall

- name: "Permitir puertos pasivos FTP"
  ufw:
    rule: allow
    port: "21000:21010"
    proto: tcp
    comment: "FTP Passive Ports"
  tags: firewall

- name: "Configuración de firewall completada"
  debug:
    msg: "Firewall configurado para servicios IPv6"
  tags: firewall

- name: "Permitir ping (ICMP)"
  ufw:
    rule: allow
    proto: icmp
  tags: firewall

- name: "Permitir ICMPv6"
  ufw:
    rule: allow
    proto: ipv6-icmp
  tags: firewall

- name: "Aplicar reglas por rol de VM"
  include_tasks: filter-by-role.yml
  when: groups['ubuntu_desktops'] is defined
  tags: firewall

- name: "Habilitar UFW"
  ufw:
    state: enabled
  tags: firewall

- name: "Copiar filtros personalizados de fail2ban"
  include_tasks: copy-filters.yml
  tags: [firewall, fail2ban]

- name: "Configurar fail2ban"
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    backup: yes
  notify: restart fail2ban
  tags: [firewall, fail2ban]

- name: "Habilitar y iniciar fail2ban"
  systemd:
    name: fail2ban
    enabled: yes
    state: started
  tags: [firewall, fail2ban]

- name: "Crear script de monitoreo de firewall"
  template:
    src: firewall-monitor.sh.j2
    dest: /usr/local/bin/firewall-monitor.sh
    mode: '0755'
    owner: root
    group: root
  tags: firewall

- name: "Crear enlace simbólico para fácil acceso"
  file:
    src: /usr/local/bin/firewall-monitor.sh
    dest: /usr/local/bin/fw-monitor
    state: link
  tags: firewall

- name: "Incluir seguridad avanzada (opcional)"
  include_role:
    name: seguridad
  when: enable_advanced_security | default(false)
  tags: [firewall, seguridad]

- name: "Mostrar estado del firewall"
  command: ufw status verbose
  register: firewall_status
  changed_when: false
  tags: firewall

- name: "Mostrar configuración aplicada"
  debug:
    var: firewall_status.stdout_lines
  tags: firewall
