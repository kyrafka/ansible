---
# ConfiguraciÃ³n avanzada del firewall con fail2ban y monitoreo

- name: "ğŸ”„ Actualizando cachÃ© de APT"
  apt:
    update_cache: yes
  tags: firewall
  
- name: "ğŸ“¦ Instalar firewall y herramientas de seguridad"
  apt:
    name:
      - ufw
      - fail2ban
      - iptables-persistent
      - netfilter-persistent
    state: present
  register: apt_install_result
  tags: firewall

- name: "âœ“ Resultado de instalaciÃ³n (Debug)"
  debug:
    var: apt_install_result
  tags: firewall

- name: "âœ“ Paquetes instalados"
  debug:
    msg: "â†’ UFW, fail2ban e iptables-persistent instalados"
  tags: firewall

- name: "ğŸ” Verificar instalaciÃ³n de UFW"
  stat:
    path: /usr/sbin/ufw
  register: ufw_binary
  tags: firewall

- name: "âŒ UFW no se instalÃ³ correctamente"
  fail:
    msg: "UFW no estÃ¡ disponible en /usr/sbin/ufw despuÃ©s de la instalaciÃ³n"
  when: not ufw_binary.stat.exists
  tags: firewall

- name: "ğŸ“ Configurar ruta de UFW"
  set_fact:
    ufw_bin: /usr/sbin/ufw
  tags: firewall

- name: "ğŸ“‹ Verificar versiÃ³n de UFW"
  command: "{{ ufw_bin }} version"
  register: ufw_version
  changed_when: false
  tags: firewall

- name: "âœ“ UFW listo"
  debug:
    msg:
      - "â†’ UbicaciÃ³n: {{ ufw_bin }}"
      - "â†’ {{ ufw_version.stdout_lines[0] }}"
  tags: firewall

- name: "ğŸ” Verificar estado actual de UFW"
  command: "{{ ufw_bin }} status"
  register: ufw_status_check
  changed_when: false
  failed_when: false
  tags: firewall

- name: "ğŸ”„ Deshabilitando UFW"
  command: "{{ ufw_bin }} --force disable"
  when: "'Status: active' in ufw_status_check.stdout"
  register: ufw_disable_result
  changed_when: ufw_disable_result.rc == 0
  failed_when: false
  tags: firewall

- name: "âœ“ UFW deshabilitado"
  debug:
    msg: "â†’ Preparando para configuraciÃ³n limpia"
  when: ufw_disable_result is changed
  tags: firewall

- name: "ğŸ”„ Reseteando configuraciÃ³n UFW"
  command: "{{ ufw_bin }} --force reset"
  register: ufw_reset_result
  changed_when: ufw_reset_result.rc == 0
  tags: firewall

- name: "âœ“ UFW reseteado"
  debug:
    msg: "â†’ ConfiguraciÃ³n limpia aplicada"
  tags: firewall

- name: "ğŸ›¡ï¸  Configurando polÃ­tica: denegar entrada"
  command: "{{ ufw_bin }} default deny incoming"
  tags: firewall

- name: "ğŸ›¡ï¸  Configurando polÃ­tica: permitir salida"
  command: "{{ ufw_bin }} default allow outgoing"
  tags: firewall

- name: "âœ“ PolÃ­ticas configuradas"
  debug:
    msg:
      - "â†’ Entrada: DENY (seguro por defecto)"
      - "â†’ Salida: ALLOW (sin restricciones)"
  tags: firewall

- name: "ğŸ” Permitiendo SSH con rate limiting"
  command: "{{ ufw_bin }} limit 22/tcp comment 'SSH con rate limiting'"
  tags: firewall

- name: "âœ“ SSH protegido"
  debug:
    msg: "â†’ Puerto 22/tcp con limitaciÃ³n de conexiones"
  tags: firewall

- name: "ğŸŒ Permitiendo DNS TCP (puerto 53)"
  command: "{{ ufw_bin }} allow 53/tcp comment 'DNS TCP'"
  tags: firewall

- name: "ğŸŒ Permitiendo DNS UDP (puerto 53)"
  command: "{{ ufw_bin }} allow 53/udp comment 'DNS UDP'"
  tags: firewall

- name: "âœ“ DNS habilitado"
  debug:
    msg: "â†’ Puerto 53 TCP/UDP abierto"
  tags: firewall

- name: "ğŸŒ Permitiendo HTTP (puerto 80)"
  command: "{{ ufw_bin }} allow 80/tcp comment 'HTTP Web Server'"
  tags: firewall

- name: "âœ“ HTTP habilitado"
  debug:
    msg: "â†’ Puerto 80 TCP abierto para Nginx"
  tags: firewall

- name: "ğŸ“¡ Permitiendo DHCPv6 Server (puerto 547)"
  command: "{{ ufw_bin }} allow 547/udp comment 'DHCPv6 Server'"
  tags: firewall

- name: "ğŸ“¡ Permitiendo DHCPv6 Client (puerto 546)"
  command: "{{ ufw_bin }} allow 546/udp comment 'DHCPv6 Client'"
  tags: firewall

- name: "âœ“ DHCP habilitado"
  debug:
    msg: "â†’ Puertos 546-547 UDP abiertos"
  tags: firewall

- name: "ğŸ“ Permitiendo puertos pasivos FTP"
  command: "{{ ufw_bin }} allow 21000:21010/tcp comment 'FTP Passive Ports'"
  tags: firewall

- name: "âœ“ FTP configurado"
  debug:
    msg: "â†’ Puertos 21000-21010 TCP abiertos"
  tags: firewall

- name: "Aplicar reglas por rol de VM"
  include_tasks: filter-by-role.yml
  when: groups['ubuntu_desktops'] is defined
  tags: firewall

- name: "ğŸ”¥ Habilitando UFW"
  command: "{{ ufw_bin }} --force enable"
  changed_when: true
  tags: firewall

- name: "âœ“ UFW habilitado"
  debug:
    msg: "â†’ Firewall activo y funcionando"
  tags: firewall

- name: "Copiar filtros personalizados de fail2ban"
  include_tasks: copy-filters.yml
  tags: [firewall, fail2ban]

- name: "Configurar fail2ban"
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    backup: yes
  notify: restart fail2ban
  tags: [firewall, fail2ban]

- name: "Habilitar y iniciar fail2ban"
  systemd:
    name: fail2ban
    enabled: yes
    state: started
  tags: [firewall, fail2ban]

- name: "Crear script de monitoreo de firewall"
  template:
    src: firewall-monitor.sh.j2
    dest: /usr/local/bin/firewall-monitor.sh
    mode: '0755'
    owner: root
    group: root
  tags: firewall

- name: "Crear enlace simbÃ³lico para fÃ¡cil acceso"
  file:
    src: /usr/local/bin/firewall-monitor.sh
    dest: /usr/local/bin/fw-monitor
    state: link
  tags: firewall

- name: "Incluir seguridad avanzada (opcional)"
  include_role:
    name: seguridad
  when: enable_advanced_security | default(false)
  tags: [firewall, seguridad]

- name: "Mostrar estado del firewall"
  command: "{{ ufw_bin }} status verbose"
  register: firewall_status
  changed_when: false
  tags: firewall

- name: "Mostrar configuraciÃ³n aplicada"
  debug:
    var: firewall_status.stdout_lines
  tags: firewall
