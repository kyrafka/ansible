#!/bin/bash
# Script de monitoreo de firewall para Proyecto SO
# Generado autom√°ticamente por Ansible

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Funci√≥n para logging
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> /var/log/firewall-monitor.log
}

# Funci√≥n para mostrar estado del firewall
show_firewall_status() {
    echo -e "${BLUE}üî• ESTADO DEL FIREWALL${NC}"
    echo "========================"
    ufw status verbose
    echo ""
    
    echo -e "${BLUE}üìä ESTAD√çSTICAS DE CONEXIONES${NC}"
    echo "=============================="
    ss -tuln | head -20
    echo ""
}

# Funci√≥n para verificar servicios cr√≠ticos
check_critical_services() {
    echo -e "${BLUE}üîß SERVICIOS CR√çTICOS${NC}"
    echo "===================="
    
    services=("ssh" "ufw" "fail2ban" "bind9" "isc-dhcp-server6")
    
    for service in "${services[@]}"; do
        if systemctl is-active --quiet "$service" 2>/dev/null; then
            echo -e "‚úÖ $service: ${GREEN}ACTIVO${NC}"
        else
            echo -e "‚ùå $service: ${RED}INACTIVO${NC}"
        fi
    done
    echo ""
}

# Funci√≥n para mostrar conexiones activas
show_active_connections() {
    echo -e "${BLUE}üåê CONEXIONES ACTIVAS${NC}"
    echo "===================="
    netstat -tuln | grep LISTEN | head -10
    echo ""
    
    echo -e "${BLUE}üìà TOP 10 CONEXIONES POR IP${NC}"
    echo "=========================="
    netstat -ntu | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head -10
    echo ""
}

# Funci√≥n para mostrar estad√≠sticas de fail2ban
show_fail2ban_stats() {
    echo -e "${BLUE}üõ°Ô∏è  ESTAD√çSTICAS FAIL2BAN${NC}"
    echo "========================="
    
    if systemctl is-active --quiet fail2ban; then
        fail2ban-client status
        echo ""
        
        # Mostrar jails activas
        jails=$(fail2ban-client status | grep "Jail list" | cut -d: -f2 | tr ',' '\n' | xargs)
        for jail in $jails; do
            echo -e "${YELLOW}Jail: $jail${NC}"
            fail2ban-client status "$jail" 2>/dev/null || echo "  No disponible"
            echo ""
        done
    else
        echo -e "${RED}Fail2ban no est√° activo${NC}"
    fi
    echo ""
}

# Funci√≥n para verificar logs de seguridad
check_security_logs() {
    echo -e "${BLUE}üìã EVENTOS DE SEGURIDAD RECIENTES${NC}"
    echo "================================="
    
    echo -e "${YELLOW}√öltimos intentos SSH fallidos:${NC}"
    grep "Failed password" /var/log/auth.log | tail -5 2>/dev/null || echo "No hay registros recientes"
    echo ""
    
    echo -e "${YELLOW}√öltimas conexiones exitosas:${NC}"
    grep "Accepted password" /var/log/auth.log | tail -5 2>/dev/null || echo "No hay registros recientes"
    echo ""
    
    echo -e "${YELLOW}Actividad UFW reciente:${NC}"
    grep "UFW" /var/log/syslog | tail -5 2>/dev/null || echo "No hay registros recientes"
    echo ""
}

# Funci√≥n para generar reporte de seguridad
generate_security_report() {
    REPORT_FILE="/var/log/security-report-$(date +%Y%m%d-%H%M).txt"
    
    {
        show_firewall_status
        check_critical_services
        show_active_connections
        show_fail2ban_stats
        check_security_logs
    } > $REPORT_FILE
    
    echo "üìÑ Reporte generado: $REPORT_FILE"
    log_message "Reporte de seguridad generado: $REPORT_FILE"
}

# Funci√≥n para mostrar ayuda
show_help() {
    echo "üîß MONITOR DE FIREWALL - PROYECTO SO"
    echo "===================================="
    echo "Uso: $0 [opci√≥n]"
    echo ""
    echo "Opciones:"
    echo "  status      - Mostrar estado del firewall"
    echo "  services    - Verificar servicios cr√≠ticos"
    echo "  connections - Mostrar conexiones activas"
    echo "  fail2ban    - Estad√≠sticas de fail2ban"
    echo "  logs        - Eventos de seguridad recientes"
    echo "  report      - Generar reporte completo"
    echo "  help        - Mostrar esta ayuda"
    echo ""
    echo "Sin par√°metros muestra un resumen completo"
}

# Funci√≥n principal
main() {
    case "${1:-all}" in
        "status")
            show_firewall_status
            ;;
        "services")
            check_critical_services
            ;;
        "connections")
            show_active_connections
            ;;
        "fail2ban")
            show_fail2ban_stats
            ;;
        "logs")
            check_security_logs
            ;;
        "report")
            generate_security_report
            ;;
        "help")
            show_help
            ;;
        "all"|*)
            show_firewall_status
            check_critical_services
            show_active_connections
            show_fail2ban_stats
            check_security_logs
            ;;
    esac
}

# Ejecutar funci√≥n principal
main "$@"