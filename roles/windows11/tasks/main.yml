---
# Rol para configurar Windows 11
# Crea usuarios, carpetas y configura firewall

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PASO 1: CREAR USUARIOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "ğŸ‘¥ Crear usuario 'dev'"
  ansible.windows.win_shell: |
    net user dev 123!123 /add
    exit 0
  ignore_errors: yes
  register: user_dev

- name: "âœ“ Usuario dev"
  ansible.builtin.debug:
    msg: "â†’ Usuario 'dev' creado (contraseÃ±a: 123!123)"
  when: user_dev.rc == 0

- name: "ğŸ‘¥ Crear usuario 'cliente'"
  ansible.windows.win_shell: |
    net user cliente 123!123 /add
    exit 0
  ignore_errors: yes
  register: user_cliente

- name: "âœ“ Usuario cliente"
  ansible.builtin.debug:
    msg: "â†’ Usuario 'cliente' creado (contraseÃ±a: 123!123)"
  when: user_cliente.rc == 0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PASO 2: CREAR CARPETAS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "ğŸ“ Crear carpetas del sistema"
  ansible.windows.win_shell: |
    New-Item -Path C:\Compartido -ItemType Directory -Force | Out-Null
    New-Item -Path C:\Dev -ItemType Directory -Force | Out-Null
    exit 0
  ignore_errors: yes
  register: folders_created

- name: "âœ“ Carpetas creadas"
  ansible.builtin.debug:
    msg:
      - "â†’ C:\\Compartido"
      - "â†’ C:\\Dev"
  when: folders_created.rc == 0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PASO 3: CONFIGURAR PERMISOS DE CARPETAS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "ğŸ” Configurar permisos en C:\\Compartido"
  ansible.windows.win_shell: |
    icacls C:\Compartido /grant "Users:(OI)(CI)M" /T
    exit 0
  ignore_errors: yes

- name: "ğŸ” Configurar permisos en C:\\Dev"
  ansible.windows.win_shell: |
    icacls C:\Dev /grant "dev:(OI)(CI)F" /T
    icacls C:\Dev /grant "Users:(OI)(CI)R" /T
    exit 0
  ignore_errors: yes

- name: "âœ“ Permisos configurados"
  ansible.builtin.debug:
    msg:
      - "â†’ C:\\Compartido: Todos los usuarios pueden modificar"
      - "â†’ C:\\Dev: dev tiene control total, otros solo lectura"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PASO 4: CONFIGURAR FIREWALL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "ğŸ”¥ Habilitar regla ICMPv6 (Ping)"
  ansible.windows.win_shell: |
    New-NetFirewallRule -Name "ICMPv6-In" -DisplayName "ICMPv6 Ping" -Protocol ICMPv6 -IcmpType 8 -Enabled True -Direction Inbound -Action Allow -ErrorAction SilentlyContinue | Out-Null
    exit 0
  ignore_errors: yes

- name: "âœ“ Ping habilitado"
  ansible.builtin.debug:
    msg: "â†’ ICMPv6 permitido en firewall"

- name: "ğŸ”¥ Habilitar compartir archivos e impresoras"
  ansible.windows.win_shell: |
    Enable-NetFirewallRule -DisplayGroup "File and Printer Sharing" -ErrorAction SilentlyContinue | Out-Null
    exit 0
  ignore_errors: yes

- name: "âœ“ Compartir archivos habilitado"
  ansible.builtin.debug:
    msg: "â†’ Reglas de compartir archivos activas"

- name: "ğŸ”¥ Habilitar WinRM (gestiÃ³n remota)"
  ansible.windows.win_shell: |
    Enable-NetFirewallRule -Name "WINRM-HTTP-In-TCP" -ErrorAction SilentlyContinue | Out-Null
    exit 0
  ignore_errors: yes

- name: "âœ“ WinRM configurado"
  ansible.builtin.debug:
    msg: "â†’ Puerto 5985 abierto para gestiÃ³n remota"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PASO 5: CONFIGURAR RED IPv6
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "ğŸŒ Verificar configuraciÃ³n IPv6"
  ansible.windows.win_shell: |
    Get-NetIPAddress -AddressFamily IPv6 | Where-Object {$_.PrefixOrigin -eq "Dhcp"} | Select-Object IPAddress, InterfaceAlias | Format-Table -AutoSize
  register: ipv6_config
  ignore_errors: yes

- name: "âœ“ IPv6 configurado"
  ansible.builtin.debug:
    msg: "â†’ Windows tiene IPv6 asignado por DHCP"
  when: ipv6_config.stdout | length > 0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PASO 6: VERIFICACIÃ“N FINAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "ğŸ” Obtener lista de usuarios"
  ansible.windows.win_shell: |
    Get-LocalUser | Select-Object Name, Enabled | Format-Table -AutoSize
  register: users_list

- name: "ğŸ” Obtener carpetas creadas"
  ansible.windows.win_shell: |
    Get-ChildItem C:\ | Where-Object {$_.Name -match 'Compartido|Dev'} | Select-Object Name, LastWriteTime | Format-Table -AutoSize
  register: folders_list

- name: "ğŸ“‹ Resumen de configuraciÃ³n"
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "âœ… WINDOWS 11 CONFIGURADO"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ‘¥ Usuarios creados:"
      - "  â€¢ dev (contraseÃ±a: 123!123)"
      - "  â€¢ cliente (contraseÃ±a: 123!123)"
      - ""
      - "ğŸ“ Carpetas creadas:"
      - "  â€¢ C:\\Compartido (todos pueden modificar)"
      - "  â€¢ C:\\Dev (dev control total)"
      - ""
      - "ğŸ”¥ Firewall configurado:"
      - "  â€¢ Ping (ICMPv6) permitido"
      - "  â€¢ Compartir archivos habilitado"
      - "  â€¢ WinRM habilitado (puerto 5985)"
      - ""
      - "ğŸŒ Red:"
      - "  â€¢ IPv6 configurado por DHCP"
      - ""
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

- name: "ğŸ“Š Usuarios de Windows"
  ansible.builtin.debug:
    var: users_list.stdout_lines

- name: "ğŸ“Š Carpetas creadas"
  ansible.builtin.debug:
    var: folders_list.stdout_lines
