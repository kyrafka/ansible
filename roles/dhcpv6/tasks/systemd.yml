---
# Configuraci√≥n de systemd y permisos

- name: Verificar que usuario dhcpd existe
  user:
    name: dhcpd
    system: yes
    create_home: no
    shell: /usr/sbin/nologin
    state: present

- name: Verificar que grupo dhcpd existe
  group:
    name: dhcpd
    system: yes
    state: present

- name: Crear directorio tmpfiles.d para DHCPv6
  copy:
    content: |
      d /run/dhcp-server6 0755 dhcpd dhcpd -
    dest: /etc/tmpfiles.d/dhcp-server6.conf
    owner: root
    group: root
    mode: '0644'

- name: Aplicar tmpfiles
  command: systemd-tmpfiles --create
  changed_when: false

- name: Crear directorio para PID de DHCPv6 (forzado)
  shell: |
    mkdir -p /run/dhcp-server6
    chown dhcpd:dhcpd /run/dhcp-server6 || chmod 777 /run/dhcp-server6
    chmod 0755 /run/dhcp-server6
  become: yes
  changed_when: true

- name: Verificar directorio PID creado
  command: ls -la /run/dhcp-server6
  register: pid_dir
  changed_when: false
  failed_when: false

- name: Mostrar estado del directorio PID
  debug:
    var: pid_dir.stdout_lines

- name: Crear directorio override para systemd
  file:
    path: /etc/systemd/system/isc-dhcp-server6.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Configurar RuntimeDirectory en systemd
  copy:
    content: |
      [Unit]
      After=systemd-tmpfiles-setup.service
      Requires=systemd-tmpfiles-setup.service
      
      [Service]
      RuntimeDirectory=dhcp-server6
      RuntimeDirectoryMode=0755
      User=dhcpd
      Group=dhcpd
      # Permisos adicionales para AppArmor
      ProtectSystem=false
      ProtectHome=false
    dest: /etc/systemd/system/isc-dhcp-server6.service.d/override.conf
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd

- name: Recargar systemd
  systemd:
    daemon_reload: yes

- name: Habilitar y arrancar servicio isc-dhcp-server6
  systemd:
    name: isc-dhcp-server6
    state: started
    enabled: yes
