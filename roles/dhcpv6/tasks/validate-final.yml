---
# Validaciones FINALES - Verificar que todo se instalÃ³ correctamente

- name: "ğŸ” Verificar que el usuario dhcpd existe"
  command: id dhcpd
  register: dhcpd_user_check
  changed_when: false
  failed_when: dhcpd_user_check.rc != 0

- name: "âœ“ Usuario dhcpd"
  debug:
    msg: "âœ… Usuario dhcpd encontrado: {{ dhcpd_user_check.stdout }}"

- name: "ğŸ” Verificar archivo de configuraciÃ³n DHCPv6"
  stat:
    path: /etc/dhcp/dhcpd6.conf
  register: dhcpd6_conf

- name: "âŒ Archivo de configuraciÃ³n no existe"
  fail:
    msg: "El archivo /etc/dhcp/dhcpd6.conf no existe despuÃ©s de la instalaciÃ³n"
  when: not dhcpd6_conf.stat.exists

- name: "âœ“ Archivo de configuraciÃ³n existe"
  debug:
    msg: "âœ… /etc/dhcp/dhcpd6.conf existe"

- name: "ğŸ” Validar sintaxis de dhcpd6.conf"
  command: dhcpd -6 -t -cf /etc/dhcp/dhcpd6.conf
  register: dhcpd_syntax
  changed_when: false
  failed_when: false

- name: "âœ“ Sintaxis de dhcpd6.conf"
  debug:
    msg: "{{ 'Correcta' if dhcpd_syntax.rc == 0 else 'ERROR: ' ~ dhcpd_syntax.stderr }}"

- name: "âŒ Error de sintaxis en dhcpd6.conf"
  fail:
    msg: "{{ dhcpd_syntax.stderr }}"
  when: dhcpd_syntax.rc != 0

- name: "ğŸ” Verificar interfaz ens34"
  command: ip -6 addr show ens34
  register: ens34_check
  changed_when: false
  failed_when: false

- name: "âœ“ Interfaz ens34"
  debug:
    var: ens34_check.stdout_lines

- name: "âŒ Interfaz ens34 no tiene IPv6"
  fail:
    msg: "La interfaz ens34 no tiene direcciÃ³n IPv6 configurada"
  when: "'2025:db8:10::' not in ens34_check.stdout"

- name: "ğŸ” Verificar servicio DHCPv6"
  systemd:
    name: isc-dhcp-server6
  register: dhcp_service
  become: true

- name: "âœ“ Servicio DHCPv6"
  debug:
    msg: "âœ… Estado: {{ dhcp_service.status.ActiveState }}"

- name: "âŒ Servicio DHCPv6 no estÃ¡ activo"
  fail:
    msg: "El servicio isc-dhcp-server6 no estÃ¡ activo"
  when: dhcp_service.status.ActiveState != "active"
