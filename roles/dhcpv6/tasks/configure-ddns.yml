---
# Configurar DDNS en DHCPv6 usando clave del vault (Idempotente)

- name: "ðŸ”‘ Crear clave DDNS desde vault"
  copy:
    content: |
      key "{{ vault_ddns_key_name }}" {
          algorithm {{ vault_ddns_key_algorithm }};
          secret "{{ vault_ddns_key_secret }}";
      };
    dest: /etc/dhcp/dhcp-key.key
    owner: root
    group: root
    mode: '0640'
  become: true
  register: ddns_key_created

- name: "âœ… Clave DDNS configurada desde vault"
  debug:
    msg: 
      - "â†’ Clave: {{ vault_ddns_key_name }}"
      - "â†’ Algoritmo: {{ vault_ddns_key_algorithm }}"
      - "â†’ UbicaciÃ³n: /etc/dhcp/dhcp-key.key"
      - "â†’ Fuente: group_vars/all.vault.yml (centralizada)"
      - "{% if ddns_key_created.changed %}â†’ Estado: Clave creada/actualizada{% else %}â†’ Estado: Clave ya estaba correcta{% endif %}"

- name: "ï¿½ RCopiar script de actualizaciÃ³n DDNS"
  copy:
    src: dhcp-ddns-update.sh
    dest: /usr/local/bin/dhcp-ddns-update.sh
    owner: root
    group: root
    mode: '0755'
  become: true

- name: "ðŸ”„ Reiniciar DHCP si se actualizÃ³ la clave"
  systemd:
    name: isc-dhcp-server6
    state: restarted
  become: true
  when: ddns_key_created.changed
