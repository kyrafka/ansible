---
# Configurar DDNS en DHCPv6 (Idempotente y robusto)

- name: "ğŸ” Verificar si existe clave DDNS en BIND"
  stat:
    path: /etc/bind/dhcp-key.key
  register: bind_key_exists
  become: true
  changed_when: false

- name: "ğŸ” Verificar si existe clave DDNS en DHCP"
  stat:
    path: /etc/dhcp/dhcp-key.key
  register: dhcp_key_exists
  become: true
  changed_when: false

- name: "ğŸ” Comparar claves DDNS (si ambas existen)"
  shell: |
    if [ -f /etc/bind/dhcp-key.key ] && [ -f /etc/dhcp/dhcp-key.key ]; then
      diff -q /etc/bind/dhcp-key.key /etc/dhcp/dhcp-key.key
      echo $?
    else
      echo "255"
    fi
  register: keys_match
  become: true
  changed_when: false
  failed_when: false

- name: "ğŸ“‹ Estado de claves DDNS"
  debug:
    msg: |
      ğŸ”‘ Estado de claves DDNS:
      {% if bind_key_exists.stat.exists and dhcp_key_exists.stat.exists %}
        {% if keys_match.stdout == "0" %}
      âœ… Ambas claves existen y COINCIDEN
      â†’ DDNS funcionarÃ¡ correctamente
        {% else %}
      âš ï¸  Ambas claves existen pero son DIFERENTES
      â†’ Se sincronizarÃ¡ la clave de BIND â†’ DHCP
        {% endif %}
      {% elif bind_key_exists.stat.exists %}
      âš ï¸  Solo existe clave en BIND
      â†’ Se copiarÃ¡ a DHCP
      {% elif dhcp_key_exists.stat.exists %}
      âš ï¸  Solo existe clave en DHCP (incorrecta)
      â†’ Se eliminarÃ¡ y esperarÃ¡ clave de BIND
      {% else %}
      âš ï¸  No existen claves DDNS
      â†’ Ejecuta primero: bash scripts/run/run-dns.sh
      {% endif %}

- name: "ğŸ—‘ï¸  Eliminar clave incorrecta de DHCP"
  file:
    path: /etc/dhcp/dhcp-key.key
    state: absent
  become: true
  when: 
    - dhcp_key_exists.stat.exists
    - not bind_key_exists.stat.exists

- name: "ğŸ”‘ Sincronizar clave DDNS (BIND â†’ DHCP)"
  copy:
    src: /etc/bind/dhcp-key.key
    dest: /etc/dhcp/dhcp-key.key
    owner: root
    group: root
    mode: '0640'
    remote_src: yes
    force: yes  # Sobrescribir siempre
  become: true
  when: bind_key_exists.stat.exists
  register: ddns_sync_result

- name: "âœ… Resultado de sincronizaciÃ³n"
  debug:
    msg: |
      {% if ddns_sync_result.changed %}
      âœ… CHANGED: Clave DDNS sincronizada correctamente
      â†’ BIND â†’ DHCP
      â†’ Ambas claves ahora coinciden
      â†’ DDNS funcionarÃ¡ correctamente
      {% elif ddns_sync_result.skipped is defined %}
      â­ï¸  SKIPPED: No hay clave en BIND para sincronizar
      â†’ Ejecuta primero: bash scripts/run/run-dns.sh
      â†’ DHCP funcionarÃ¡ sin DDNS (solo asignarÃ¡ IPs)
      {% else %}
      âœ… OK: Claves ya estaban sincronizadas
      â†’ No se necesitaron cambios
      {% endif %}
  when: ddns_sync_result is defined

- name: "ğŸ”„ Reiniciar DHCP si se sincronizÃ³ la clave"
  systemd:
    name: isc-dhcp-server6
    state: restarted
  become: true
  when: 
    - ddns_sync_result is defined
    - ddns_sync_result.changed
