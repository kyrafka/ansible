---
# Configurar DDNS en DHCPv6

- name: "ğŸ” Verificar si existe clave DDNS"
  stat:
    path: /etc/bind/dhcp-key.key
  register: ddns_key_exists
  become: true
  changed_when: false  # Solo es verificaciÃ³n, no cambia nada

- name: "ğŸ“‹ Estado de DDNS"
  debug:
    msg: |
      {% if ddns_key_exists.stat.exists %}
      âœ… Clave DDNS encontrada en /etc/bind/dhcp-key.key
      â†’ Se configurarÃ¡ actualizaciÃ³n dinÃ¡mica de DNS
      {% else %}
      âš ï¸  Clave DDNS NO encontrada en /etc/bind/dhcp-key.key
      â†’ DHCP funcionarÃ¡ SIN actualizaciÃ³n dinÃ¡mica de DNS
      â†’ Esto es NORMAL si no ejecutaste run-dns.sh primero
      â†’ Para habilitar DDNS: bash scripts/run/run-dns.sh
      {% endif %}

- name: "ğŸ”‘ Copiar clave DDNS para DHCP"
  copy:
    src: /etc/bind/dhcp-key.key
    dest: /etc/dhcp/dhcp-key.key
    owner: root
    group: root
    mode: '0640'
    remote_src: yes
  become: true
  when: ddns_key_exists.stat.exists
  register: ddns_copy_result

- name: "ğŸ“Š Resultado de copia de clave DDNS"
  debug:
    msg: |
      {% if ddns_copy_result.changed %}
      âœ… CHANGED: Clave DDNS copiada a /etc/dhcp/dhcp-key.key
      â†’ Motivo: Primera instalaciÃ³n o clave actualizada
      â†’ DHCP ahora puede actualizar registros DNS automÃ¡ticamente
      {% elif ddns_copy_result.skipped is defined %}
      â­ï¸  SKIPPED: Copia de clave DDNS omitida
      â†’ Motivo: Clave DDNS no existe (DNS no configurado)
      â†’ Esto es NORMAL si ejecutas DHCP antes que DNS
      {% else %}
      âœ… OK: Clave DDNS ya estaba configurada correctamente
      â†’ No se necesitaron cambios
      {% endif %}
  when: ddns_copy_result is defined
