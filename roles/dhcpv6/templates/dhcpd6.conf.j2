# Configuración global de DHCPv6 con DNS Dinámico
default-lease-time {{ dhcp6_config.default_lease_time | default(600) }};
max-lease-time {{ dhcp6_config.max_lease_time | default(7200) }};

# Configuración de DNS Dinámico (DDNS)
ddns-update-style interim;
ddns-domainname "{{ network_config.domain_name }}.";
ddns-rev-domainname "ip6.arpa.";
ignore client-updates;
update-static-leases on;

# Configuración de actualización de DNS
ddns-updates on;
do-forward-updates on;

# Clave compartida con BIND9
include "/etc/dhcp/dhcp-key.key";

# Zona DNS para actualizaciones dinámicas
zone {{ network_config.domain_name }}. {
    primary 127.0.0.1;
    key dhcp-key;
}

zone {{ dns_ipv6_reverse_zone }}. {
    primary 127.0.0.1;
    key dhcp-key;
}

# Configuración de hostname para DDNS
on commit {
    set ClientIP = binary-to-ascii(16, 16, ":", substring(hardware, 1, 16));
    set ClientDUID = binary-to-ascii(16, 8, ":", option dhcp6.client-id);
    set ClientName = pick-first-value(option host-name, option fqdn.hostname, "unknown");
    
    log(concat("Commit: IP=", ClientIP, " DUID=", ClientDUID, " Name=", ClientName));
    
    execute("/usr/local/bin/dhcp-ddns-update.sh", "add", ClientName, ClientIP);
}

# Configuración de la red principal
subnet6 {{ network_config.ipv6_network }} {
    range6 {{ network_config.dhcp_range_start }} {{ network_config.dhcp_range_end }};
    
    # Asignar direcciones con prefijo /64 en lugar de /128
    option dhcp6.ia-na-options code 3 = { integer 32, integer 32, integer 16, ip6-address };
    
    option dhcp6.name-servers 2025:db8:10::2;
    option dhcp6.domain-search "{{ network_config.domain_name }}";
    
    # Información del prefijo de red
    prefix6 2025:db8:10:: 2025:db8:10::ffff:ffff:ffff:ffff /64;
}