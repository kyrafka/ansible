---
# ConfiguraciÃ³n de NAT64 con Tayga para traducciÃ³n IPv6 â†’ IPv4

- name: "ğŸ“¦ Instalar Tayga (NAT64)"
  ansible.builtin.apt:
    name: tayga
    state: present
    update_cache: yes
  become: true

- name: "âœ“ Tayga instalado"
  ansible.builtin.debug:
    msg: "â†’ NAT64 disponible para traducciÃ³n IPv6 â†’ IPv4"

- name: "ğŸ“ Configurar Tayga"
  ansible.builtin.template:
    src: tayga.conf.j2
    dest: /etc/tayga.conf
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: restart tayga

- name: "ğŸ“ Crear directorio de datos de Tayga"
  ansible.builtin.file:
    path: /var/db/tayga
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: "ğŸ”§ Crear interfaz virtual nat64"
  ansible.builtin.shell: |
    if ! ip link show nat64 &>/dev/null; then
      ip tuntap add dev nat64 mode tun
      ip link set nat64 up
      ip addr add 192.168.255.1/24 dev nat64
      ip addr add 64:ff9b::1/96 dev nat64
    fi
  become: true
  changed_when: false

- name: "âœ“ Interfaz nat64 creada"
  ansible.builtin.debug:
    msg:
      - "â†’ Interfaz: nat64"
      - "â†’ IPv4: 192.168.255.1/24"
      - "â†’ IPv6: 64:ff9b::1/96"

- name: "ğŸ”€ Configurar rutas para NAT64"
  ansible.builtin.shell: |
    # Ruta para el pool IPv6 de NAT64
    ip -6 route add 64:ff9b::/96 dev nat64 2>/dev/null || true
    # Ruta para el pool IPv4 de Tayga
    ip -4 route add 192.168.255.0/24 dev nat64 2>/dev/null || true
  become: true
  changed_when: false

- name: "âœ“ Rutas configuradas"
  ansible.builtin.debug:
    msg: "â†’ TrÃ¡fico IPv6 â†’ 64:ff9b::/96 â†’ Tayga â†’ IPv4"

- name: "ğŸ›¡ï¸ Configurar NAT para Tayga"
  ansible.builtin.shell: |
    # NAT para el trÃ¡fico que sale de Tayga hacia internet
    iptables -t nat -C POSTROUTING -s 192.168.255.0/24 -o {{ wan_interface }} -j MASQUERADE 2>/dev/null || \
    iptables -t nat -A POSTROUTING -s 192.168.255.0/24 -o {{ wan_interface }} -j MASQUERADE
  become: true
  changed_when: false

- name: "âœ“ NAT configurado para Tayga"
  ansible.builtin.debug:
    msg: "â†’ Pool 192.168.255.0/24 â†’ MASQUERADE â†’ {{ wan_interface }}"

- name: "ğŸ’¾ Guardar reglas de iptables"
  ansible.builtin.shell: |
    iptables-save > /etc/iptables/rules.v4
  become: true
  changed_when: true

- name: "ğŸ”„ Habilitar y iniciar Tayga"
  ansible.builtin.systemd:
    name: tayga
    enabled: yes
    state: started
  become: true

- name: "âœ“ Tayga activo"
  ansible.builtin.debug:
    msg: "â†’ NAT64 funcionando"

- name: "ğŸ“ Crear script de persistencia de interfaz nat64"
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Script para recrear interfaz nat64 al iniciar
      
      if ! ip link show nat64 &>/dev/null; then
        ip tuntap add dev nat64 mode tun
        ip link set nat64 up
        ip addr add 192.168.255.1/24 dev nat64
        ip addr add 64:ff9b::1/96 dev nat64
        ip -6 route add 64:ff9b::/96 dev nat64
        ip -4 route add 192.168.255.0/24 dev nat64
      fi
    dest: /usr/local/bin/setup-nat64.sh
    owner: root
    group: root
    mode: '0755'
  become: true

- name: "ğŸ“ Crear servicio systemd para nat64"
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Setup NAT64 interface
      After=network.target
      Before=tayga.service
      
      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/setup-nat64.sh
      RemainAfterExit=yes
      
      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/nat64-setup.service
    owner: root
    group: root
    mode: '0644'
  become: true

- name: "ğŸ”„ Recargar systemd"
  ansible.builtin.systemd:
    daemon_reload: yes
  become: true

- name: "ğŸ”„ Habilitar servicio nat64-setup"
  ansible.builtin.systemd:
    name: nat64-setup
    enabled: yes
    state: started
  become: true

- name: "âœ“ Persistencia configurada"
  ansible.builtin.debug:
    msg: "â†’ Interfaz nat64 se recrearÃ¡ automÃ¡ticamente al reiniciar"

- name: "ğŸ” Verificar estado de Tayga"
  ansible.builtin.command: systemctl status tayga
  register: tayga_status
  become: true
  changed_when: false
  failed_when: false

- name: "âœ… NAT64 configurado"
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "âœ… NAT64 (Tayga) configurado"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "â†’ Prefijo NAT64: 64:ff9b::/96"
      - "â†’ Pool IPv4: 192.168.255.0/24"
      - "â†’ Interfaz: nat64"
      - "â†’ Estado: {{ 'Activo' if 'active (running)' in tayga_status.stdout else 'Verificar' }}"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "Las VMs IPv6 ahora pueden acceder a internet IPv4"
      - "Ejemplo: ping6 64:ff9b::8.8.8.8 (Google DNS)"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
