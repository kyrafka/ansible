---
# ConfiguraciÃ³n de NAT64 con Tayga para traducciÃ³n IPv6 â†’ IPv4

- name: "ğŸ“¦ Instalar Tayga (NAT64)"
  ansible.builtin.apt:
    name: tayga
    state: present
    update_cache: yes
  become: true

- name: "âœ“ Tayga instalado"
  ansible.builtin.debug:
    msg: "â†’ NAT64 disponible para traducciÃ³n IPv6 â†’ IPv4"

- name: "ğŸ”§ Habilitar IP forwarding IPv4"
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes
  become: true

- name: "ğŸ”§ Habilitar IP forwarding IPv6"
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes
  become: true

- name: "âœ“ IP forwarding habilitado"
  ansible.builtin.debug:
    msg: "â†’ Forwarding IPv4 e IPv6 activo"

- name: "ğŸ§¹ Detener Tayga si estÃ¡ corriendo"
  ansible.builtin.systemd:
    name: tayga
    state: stopped
  become: true
  failed_when: false

- name: "ğŸ§¹ Limpiar interfaz nat64 existente"
  ansible.builtin.shell: |
    # Detener cualquier proceso tayga corriendo
    pkill -9 tayga 2>/dev/null || true
    sleep 1
    # Eliminar interfaz nat64 si existe
    if ip link show nat64 &>/dev/null; then
      ip link set nat64 down 2>/dev/null || true
      ip link delete nat64 2>/dev/null || true
    fi
    # Limpiar directorio de datos
    rm -rf /var/db/tayga/*
  become: true
  changed_when: false

- name: "ğŸ“ Configurar Tayga"
  ansible.builtin.template:
    src: tayga.conf.j2
    dest: /etc/tayga.conf
    owner: root
    group: root
    mode: '0644'
  become: true

- name: "ğŸ“ Crear directorio de datos de Tayga"
  ansible.builtin.file:
    path: /var/db/tayga
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: "ğŸ”§ Inicializar base de datos de Tayga"
  ansible.builtin.command: tayga --mktun
  become: true
  changed_when: false
  failed_when: false

- name: "âœ“ Interfaz nat64 inicializada"
  ansible.builtin.debug:
    msg: "â†’ Tayga crearÃ¡ la interfaz automÃ¡ticamente"

- name: "ğŸ”„ Habilitar e iniciar Tayga"
  ansible.builtin.systemd:
    name: tayga
    state: started
    enabled: yes
  become: true
  register: tayga_start

- name: "â³ Esperar a que interfaz nat64 exista (mÃ¡ximo 30 segundos)"
  ansible.builtin.shell: |
    for i in {1..30}; do
      if ip link show nat64 &>/dev/null; then
        echo "Interfaz nat64 encontrada despuÃ©s de $i segundos"
        exit 0
      fi
      sleep 1
    done
    echo "ERROR: Interfaz nat64 no se creÃ³ despuÃ©s de 30 segundos"
    exit 1
  become: true
  register: nat64_wait
  changed_when: false

- name: "ğŸ”§ Levantar interfaz nat64"
  ansible.builtin.command: ip link set nat64 up
  become: true
  changed_when: false

- name: "â³ Verificar que interfaz nat64 estÃ¡ UP"
  ansible.builtin.shell: |
    for i in {1..10}; do
      STATE=$(ip link show nat64 | grep -o "state [A-Z]*" | awk '{print $2}')
      if [ "$STATE" == "UP" ] || [ "$STATE" == "UNKNOWN" ]; then
        echo "Interfaz nat64 estÃ¡ $STATE"
        exit 0
      fi
      sleep 1
    done
    echo "ERROR: Interfaz nat64 no estÃ¡ UP"
    exit 1
  become: true
  register: nat64_up
  changed_when: false

- name: "ğŸ”€ Configurar rutas para NAT64"
  ansible.builtin.shell: |
    # Eliminar rutas viejas si existen
    ip -6 route del 64:ff9b::/96 dev nat64 2>/dev/null || true
    ip -4 route del 192.168.255.0/24 dev nat64 2>/dev/null || true
    
    # Agregar rutas nuevas
    ip -6 route add 64:ff9b::/96 dev nat64
    ip -4 route add 192.168.255.0/24 dev nat64
  become: true
  changed_when: true

- name: "âœ“ Verificar que rutas se crearon correctamente"
  ansible.builtin.shell: |
    if ! ip -6 route | grep -q "64:ff9b::/96 dev nat64"; then
      echo "ERROR: Ruta IPv6 NAT64 no existe"
      exit 1
    fi
    
    if ! ip -4 route | grep -q "192.168.255.0/24 dev nat64"; then
      echo "ERROR: Ruta IPv4 NAT64 no existe"
      exit 1
    fi
    
    echo "âœ… Ambas rutas NAT64 configuradas correctamente"
  become: true
  register: nat64_routes_check
  changed_when: false

- name: "âœ“ Rutas configuradas"
  ansible.builtin.debug:
    msg: "â†’ TrÃ¡fico IPv6 â†’ 64:ff9b::/96 â†’ Tayga â†’ IPv4"

- name: "ğŸ›¡ï¸ Configurar NAT para Tayga"
  ansible.builtin.shell: |
    # NAT para el trÃ¡fico que sale de Tayga hacia internet
    iptables -t nat -C POSTROUTING -s 192.168.255.0/24 -o {{ wan_interface }} -j MASQUERADE 2>/dev/null || \
    iptables -t nat -A POSTROUTING -s 192.168.255.0/24 -o {{ wan_interface }} -j MASQUERADE
  become: true
  changed_when: false

- name: "âœ“ NAT configurado para Tayga"
  ansible.builtin.debug:
    msg: "â†’ Pool 192.168.255.0/24 â†’ MASQUERADE â†’ {{ wan_interface }}"

- name: "ğŸ’¾ Guardar reglas de iptables"
  ansible.builtin.shell: |
    iptables-save > /etc/iptables/rules.v4
  become: true
  changed_when: true

- name: "âœ“ Tayga iniciado en segundo plano"
  ansible.builtin.debug:
    msg: "â†’ NAT64 iniciÃ¡ndose..."

- name: "ğŸ“ Crear script de post-inicio para rutas NAT64"
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Script para configurar rutas despuÃ©s de que Tayga inicie
      
      sleep 2
      ip link set nat64 up 2>/dev/null || true
      ip -6 route add 64:ff9b::/96 dev nat64 2>/dev/null || true
      ip -4 route add 192.168.255.0/24 dev nat64 2>/dev/null || true
    dest: /usr/local/bin/setup-nat64-routes.sh
    owner: root
    group: root
    mode: '0755'
  become: true

- name: "ğŸ“ Modificar servicio Tayga para configurar rutas"
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Tayga NAT64 daemon
      After=network.target
      
      [Service]
      Type=forking
      ExecStartPre=-/usr/sbin/tayga --mktun
      ExecStart=/usr/sbin/tayga
      ExecStartPost=/bin/sleep 2
      ExecStartPost=-/usr/local/bin/setup-nat64-routes.sh
      ExecStopPost=-/usr/sbin/tayga --rmtun
      PIDFile=/run/tayga.pid
      TimeoutStartSec=60s
      Restart=on-failure
      RestartSec=5s
      
      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/tayga.service
    owner: root
    group: root
    mode: '0644'
  become: true

- name: "ğŸ”„ Recargar systemd"
  ansible.builtin.systemd:
    daemon_reload: yes
  become: true

- name: "âœ“ Persistencia configurada"
  ansible.builtin.debug:
    msg: "â†’ Rutas NAT64 se configurarÃ¡n automÃ¡ticamente al iniciar"

- name: "ğŸ” Verificar estado de Tayga (sin fallar)"
  ansible.builtin.shell: systemctl is-active tayga || echo "starting"
  register: tayga_status
  become: true
  changed_when: false
  failed_when: false

- name: "âœ… NAT64 configurado"
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "âœ… NAT64 (Tayga) configurado"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "â†’ Prefijo NAT64: 64:ff9b::/96"
      - "â†’ Pool IPv4: 192.168.255.0/24"
      - "â†’ Interfaz: nat64"
      - "â†’ Estado: {{ tayga_status.stdout }}"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "Verifica con: sudo systemctl status tayga"
      - "Prueba con: ping6 64:ff9b::8.8.8.8"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
