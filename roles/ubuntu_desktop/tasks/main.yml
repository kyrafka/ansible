---
- name: Detectar rol de la VM
  ansible.builtin.set_fact:
    vm_role: "{{ hostvars[inventory_hostname].vm_role | default('cliente') }}"

- name: Validar rol
  ansible.builtin.assert:
    that:
      - vm_role in ['admin', 'auditor', 'cliente']
    fail_msg: "Rol debe ser: admin, auditor o cliente"

- name: Actualizar sistema
  ansible.builtin.apt:
    update_cache: true
    upgrade: dist
  become: true

- name: Instalar paquetes base
  ansible.builtin.apt:
    name:
      - openssh-server
      - ufw
      - net-tools
      - curl
      - wget
      - gnome-tweaks
      - gnome-shell-extensions
      - chrome-gnome-shell
      - dconf-editor
      - htop
      - neofetch
    state: present
  become: true

- name: Optimizar rendimiento de GNOME
  ansible.builtin.shell: |
    gsettings set org.gnome.desktop.interface enable-animations false
    gsettings set org.gnome.desktop.interface gtk-enable-animations false
    gsettings set org.gnome.mutter dynamic-workspaces false
    gsettings set org.gnome.shell.overrides workspaces-only-on-primary true
  become: false
  ignore_errors: yes

- name: Configurar tema oscuro
  ansible.builtin.shell: |
    gsettings set org.gnome.desktop.interface gtk-theme 'Yaru-dark'
    gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
  become: false
  ignore_errors: yes

- name: Deshabilitar servicios innecesarios
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: no
    state: stopped
  loop:
    - bluetooth.service
    - cups.service
    - avahi-daemon.service
  become: true
  ignore_errors: yes

- name: Optimizar swappiness
  ansible.builtin.sysctl:
    name: vm.swappiness
    value: '10'
    state: present
  become: true

- name: Limpiar paquetes innecesarios
  ansible.builtin.apt:
    autoremove: yes
    autoclean: yes
  become: true

- name: Crear grupo pcgamers
  ansible.builtin.group:
    name: pcgamers
    state: present
  become: true

# Crear TODOS los usuarios
- name: Crear usuario admin
  ansible.builtin.user:
    name: "{{ ubuntu_desktop_users.admin.username }}"
    password: "{{ ubuntu_desktop_users.admin.password | password_hash('sha512') }}"
    groups: sudo,adm,systemd-journal
    shell: /bin/bash
    create_home: true
  become: true

- name: Crear usuario auditor
  ansible.builtin.user:
    name: "{{ ubuntu_desktop_users.auditor.username }}"
    password: "{{ ubuntu_desktop_users.auditor.password | password_hash('sha512') }}"
    groups: adm,systemd-journal
    shell: /bin/bash
    create_home: true
  become: true

- name: Crear usuario cliente
  ansible.builtin.user:
    name: "{{ ubuntu_desktop_users.cliente.username }}"
    password: "{{ ubuntu_desktop_users.cliente.password | password_hash('sha512') }}"
    groups: pcgamers
    shell: /bin/bash
    create_home: true
  become: true

# Crear carpetas compartidas
- name: Crear carpetas base
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: '/srv/admin', owner: 'administrador', group: 'administrador', mode: '0755' }
    - { path: '/srv/audits', owner: 'auditor', group: 'auditor', mode: '0755' }
    - { path: '/srv/games', owner: 'root', group: 'pcgamers', mode: '0775' }
    - { path: '/srv/instaladores', owner: 'root', group: 'root', mode: '0755' }
  become: true

# Configurar permisos especÃ­ficos para cada usuario
- name: Configurar permisos para usuario admin
  ansible.builtin.include_tasks: "admin.yml"

- name: Configurar permisos para usuario auditor
  ansible.builtin.include_tasks: "auditor.yml"

- name: Configurar permisos para usuario cliente
  ansible.builtin.include_tasks: "cliente.yml"

- name: Configurar firewall bÃ¡sico
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
  loop:
    - '22'    # SSH
    - '53'    # DNS
    - '80'    # HTTP
    - '443'   # HTTPS
  become: true

- name: Habilitar firewall
  community.general.ufw:
    state: enabled
  become: true

- name: Habilitar SSH
  ansible.builtin.service:
    name: ssh
    state: started
    enabled: true
  become: true

- name: Resumen de configuraciÃ³n
  ansible.builtin.debug:
    msg:
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - "âœ… ConfiguraciÃ³n completada para {{ inventory_hostname }}"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - ""
      - "ğŸ‘¥ Usuarios creados con sus permisos:"
      - ""
      - "  ğŸ”‘ administrador:"
      - "     - Sudo completo"
      - "     - Puede SSH al servidor"
      - "     - Escritura en /srv/games y /srv/instaladores"
      - ""
      - "  ğŸ‘ï¸  auditor:"
      - "     - Solo lectura de logs"
      - "     - NO puede SSH al servidor"
      - "     - Solo lectura en /srv/games"
      - ""
      - "  ğŸ® gamer01:"
      - "     - Sin sudo"
      - "     - NO puede SSH al servidor"
      - "     - Solo lectura en /srv/games"
      - ""
      - "ğŸ“ Carpetas creadas:"
      - "  - /srv/admin (privada admin)"
      - "  - /srv/audits (privada auditor)"
      - "  - /srv/games (compartida)"
      - "  - /srv/instaladores (compartida)"
      - ""
      - "ğŸ”¥ Firewall configurado y activo"
      - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
