---
# Configurar DNS DinÃ¡mico (DDNS) usando clave del vault

- name: "ğŸ”‘ Crear clave DDNS desde vault"
  copy:
    content: |
      key "{{ vault_ddns_key_name }}" {
          algorithm {{ vault_ddns_key_algorithm }};
          secret "{{ vault_ddns_key_secret }}";
      };
    dest: /etc/bind/dhcp-key.key
    owner: bind
    group: bind
    mode: '0640'
  become: true

- name: "ğŸ›¡ï¸ Configurar AppArmor para permitir acceso a dhcp-key.key"
  lineinfile:
    path: /etc/apparmor.d/local/usr.sbin.named
    line: '  /etc/bind/dhcp-key.key r,'
    create: yes
    state: present
  become: true
  notify: reload apparmor

- name: "ğŸ›¡ï¸ Recargar AppArmor inmediatamente"
  command: apparmor_parser -r /etc/apparmor.d/usr.sbin.named
  become: true
  failed_when: false
  changed_when: false

- name: "ğŸ”— Incluir clave TSIG en named.conf"
  lineinfile:
    path: /etc/bind/named.conf
    line: 'include "/etc/bind/dhcp-key.key";'
    insertafter: EOF
    state: present
  become: true

- name: "âœ… Clave DDNS configurada desde vault"
  debug:
    msg: 
      - "â†’ Clave: {{ vault_ddns_key_name }}"
      - "â†’ Algoritmo: {{ vault_ddns_key_algorithm }}"
      - "â†’ UbicaciÃ³n: /etc/bind/dhcp-key.key"
      - "â†’ Fuente: group_vars/all.vault.yml (centralizada)"
