---
# Configurar systemd-resolved para coexistir con BIND9
# En lugar de deshabilitarlo completamente, lo configuramos para que no use el puerto 53

- name: "âš™ï¸  Configurar systemd-resolved para NO usar puerto 53"
  lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    create: yes
  loop:
    - { regexp: '^#?DNSStubListener=', line: 'DNSStubListener=no' }
    - { regexp: '^#?DNS=', line: 'DNS=127.0.0.1' }
    - { regexp: '^#?Domains=', line: 'Domains={{ dns_domain_name }}' }
  notify: restart systemd-resolved

- name: "ğŸ”„ Reiniciar systemd-resolved con nueva configuraciÃ³n"
  systemd:
    name: systemd-resolved
    state: restarted
    daemon_reload: yes

- name: "ğŸ”— Eliminar enlace simbÃ³lico de resolv.conf"
  file:
    path: /etc/resolv.conf
    state: absent

- name: "ğŸ“ Crear resolv.conf para usar BIND9 local con fallback"
  copy:
    content: |
      # ConfiguraciÃ³n DNS gestionada por Ansible
      # Usa BIND9 local como servidor DNS autoritativo
      # Con fallback a DNS pÃºblicos si BIND falla
      nameserver 127.0.0.1
      nameserver 8.8.8.8
      nameserver 8.8.4.4
      search {{ dns_domain_name }}
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: '0644'
