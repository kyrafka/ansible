---
# ConfiguraciÃ³n de DNS64 en BIND
# Permite que clientes IPv6-only resuelvan nombres a IPs traducibles

- name: "ğŸ” Verificar si BIND estÃ¡ instalado"
  ansible.builtin.stat:
    path: /etc/bind/named.conf
  register: bind_check
  become: true

- name: "âš ï¸  BIND no estÃ¡ instalado"
  ansible.builtin.fail:
    msg: "BIND debe estar instalado primero. Ejecuta el rol dns_bind completo."
  when: not bind_check.stat.exists

- name: "ğŸ“ Configurar DNS64 en BIND"
  ansible.builtin.blockinfile:
    path: /etc/bind/named.conf.options
    marker: "# {mark} ANSIBLE MANAGED BLOCK - DNS64"
    insertafter: "recursion yes;"
    block: |
      
          // DNS64 - Traduce respuestas A (IPv4) a AAAA (IPv6)
          dns64 64:ff9b::/96 {
              clients { any; };
              mapped { any; };
              exclude { any; };
              recursive-only yes;
              break-dnssec yes;
          };
    backup: yes
  become: true

- name: "ğŸš« Deshabilitar zona reversa automÃ¡tica para DNS64"
  ansible.builtin.blockinfile:
    path: /etc/bind/named.conf.local
    marker: "# {mark} ANSIBLE MANAGED BLOCK - DISABLE DNS64 REVERSE"
    block: |
      
      // Deshabilitar zona reversa automÃ¡tica para prefijo DNS64
      zone "b.9.f.f.4.6.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa" {
          type master;
          file "/dev/null";
      };
    insertafter: EOF
  become: true

- name: "âœ“ DNS64 configurado"
  ansible.builtin.debug:
    msg:
      - "â†’ Prefijo DNS64: 64:ff9b::/96"
      - "â†’ Cuando un cliente IPv6 pide google.com:"
      - "  1. BIND consulta y obtiene 142.250.185.46 (IPv4)"
      - "  2. BIND responde 64:ff9b::8efa:b92e (IPv6)"
      - "  3. El cliente envÃ­a paquetes a esa IPv6"
      - "  4. NAT64 traduce a IPv4 y envÃ­a a internet"

- name: "ğŸ”„ Verificar configuraciÃ³n de BIND"
  ansible.builtin.command: named-checkconf
  become: true
  register: bind_check_result
  changed_when: false
  failed_when: bind_check_result.rc != 0

- name: "âœ“ ConfiguraciÃ³n vÃ¡lida"
  ansible.builtin.debug:
    msg: "â†’ named-checkconf: OK"
