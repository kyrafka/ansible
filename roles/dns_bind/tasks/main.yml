---
# Instalaci√≥n y configuraci√≥n de BIND9 para DNS

- name: "üßπ Limpiar configuraci√≥n DNS anterior"
  block:
    - name: "Detener BIND9 si est√° corriendo"
      systemd:
        name: bind9
        state: stopped
      failed_when: false
    
    - name: "Eliminar archivos de configuraci√≥n antiguos"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/bind/named.conf.local
        - /var/lib/bind/db.gamecenter.local
        - /var/lib/bind/db.gamecenter.local.jnl
        - /var/lib/bind/db.gamecenter.lan
        - /var/lib/bind/db.gamecenter.lan.jnl
        - /var/lib/bind/db.0.1.0.8.b.d.5.2.0.2.ip6.arpa
        - /var/lib/bind/db.0.1.0.8.b.d.5.2.0.2.ip6.arpa.jnl
      failed_when: false
    
    - name: "Limpiar zonas est√°ticas antiguas"
      shell: rm -f /etc/bind/zones/db.* 2>/dev/null || true
      changed_when: false
  become: true

- name: "üîß Configurar systemd-resolved para coexistir con BIND9"
  include_tasks: configure-systemd-resolved.yml

- name: "Actualizar cach√© de apt"
  apt:
    update_cache: yes
    cache_valid_time: 3600
  retries: 3
  delay: 10
  register: apt_update
  until: apt_update is success

- name: "Instalar BIND9 y herramientas DNS"
  apt:
    name:
      - bind9
      - bind9utils
      - bind9-doc
      - dnsutils
      - apparmor-utils
    state: present
  retries: 3
  delay: 10

- name: "Crear directorio para zonas DNS est√°ticas"
  file:
    path: /etc/bind/zones
    state: directory
    owner: bind
    group: bind
    mode: '0755'

- name: "Crear zona vac√≠a para DNS64 reverse"
  copy:
    content: |
      $TTL 86400
      @   IN  SOA localhost. root.localhost. (
                  1       ; Serial
                  3600    ; Refresh
                  1800    ; Retry
                  604800  ; Expire
                  86400 ) ; Minimum TTL
          IN  NS  localhost.
    dest: /etc/bind/zones/db.empty
    owner: bind
    group: bind
    mode: '0644'
  become: true

- name: "Crear directorio para zonas DNS din√°micas"
  file:
    path: /var/lib/bind
    state: directory
    owner: bind
    group: bind
    mode: '0775'

- name: "Asegurar permisos correctos en /var/lib/bind"
  file:
    path: /var/lib/bind
    state: directory
    owner: bind
    group: bind
    mode: '0775'
    recurse: yes

- name: "Crear directorio para logs de BIND"
  file:
    path: /var/log/named
    state: directory
    owner: bind
    group: bind
    mode: '0755'

- name: "Configurar named.conf principal"
  template:
    src: named.conf.j2
    dest: /etc/bind/named.conf
    owner: root
    group: bind
    mode: '0644'
    backup: yes

- name: "Configurar named.conf.options"
  template:
    src: named.conf.options.j2
    dest: /etc/bind/named.conf.options
    owner: root
    group: bind
    mode: '0644'
    backup: yes

- name: "Eliminar named.conf.local antiguo para forzar regeneraci√≥n"
  file:
    path: /etc/bind/named.conf.local
    state: absent
  become: true

- name: "Configurar named.conf.local"
  template:
    src: named.conf.local.j2
    dest: /etc/bind/named.conf.local
    owner: root
    group: bind
    mode: '0644'
    backup: no

- name: "Crear zona directa para el dominio (template inicial)"
  template:
    src: db.domain.j2
    dest: "/etc/bind/zones/db.{{ dns_domain_name }}"
    owner: bind
    group: bind
    mode: '0644'
    backup: yes

- name: "Verificar si zona din√°mica existe"
  stat:
    path: "/var/lib/bind/db.{{ dns_domain_name }}"
  register: dynamic_zone_exists

- name: "Copiar zona directa a directorio din√°mico (primera vez)"
  copy:
    src: "/etc/bind/zones/db.{{ dns_domain_name }}"
    dest: "/var/lib/bind/db.{{ dns_domain_name }}"
    owner: bind
    group: bind
    mode: '0664'
    remote_src: yes
  when: not dynamic_zone_exists.stat.exists

- name: "Eliminar journal antiguo en primera instalaci√≥n"
  file:
    path: "/var/lib/bind/db.{{ dns_domain_name }}.jnl"
    state: absent
  when: not dynamic_zone_exists.stat.exists

- name: "Crear zona inversa IPv6 (template inicial)"
  template:
    src: db.ipv6.reverse.j2
    dest: "/etc/bind/zones/db.{{ dns_ipv6_reverse_zone }}"
    owner: bind
    group: bind
    mode: '0644'
    backup: yes

- name: "Verificar si zona inversa din√°mica existe"
  stat:
    path: "/var/lib/bind/db.{{ dns_ipv6_reverse_zone }}"
  register: dynamic_reverse_exists

- name: "Copiar zona inversa a directorio din√°mico"
  copy:
    src: "/etc/bind/zones/db.{{ dns_ipv6_reverse_zone }}"
    dest: "/var/lib/bind/db.{{ dns_ipv6_reverse_zone }}"
    owner: bind
    group: bind
    mode: '0664'
    remote_src: yes
  when: not dynamic_reverse_exists.stat.exists

- name: "Eliminar journal inverso antiguo si existe"
  file:
    path: "/var/lib/bind/db.{{ dns_ipv6_reverse_zone }}.jnl"
    state: absent
  when: not dynamic_reverse_exists.stat.exists

- name: "Configurar logrotate para BIND"
  template:
    src: bind-logrotate.j2
    dest: /etc/logrotate.d/bind9
    owner: root
    group: root
    mode: '0644'

- name: "üõ°Ô∏è  Configurar AppArmor para BIND9 (modo complain)"
  command: aa-complain /usr/sbin/named
  register: apparmor_result
  changed_when: false
  failed_when: false

- name: "üîê Asegurar permisos correctos en archivos de configuraci√≥n"
  file:
    path: "{{ item }}"
    owner: bind
    group: bind
    mode: '0640'
    state: file
  loop:
    - /etc/bind/dhcp-key.key
  become: true
  failed_when: false

- name: "Habilitar y iniciar servicio BIND9"
  systemd:
    name: bind9
    enabled: yes
    state: started

- name: "‚úîÔ∏è  Verificar configuraci√≥n de BIND"
  command: named-checkconf
  register: bind_config_check
  changed_when: false
  failed_when: bind_config_check.rc != 0

- name: "‚úÖ Configuraci√≥n de BIND v√°lida"
  debug:
    msg: "‚Üí named-checkconf: OK"

- name: "‚úîÔ∏è  Verificar zona directa"
  command: "named-checkzone {{ dns_domain_name }} /etc/bind/zones/db.{{ dns_domain_name }}"
  register: zone_check
  changed_when: false
  failed_when: zone_check.rc != 0

- name: "‚úÖ Zona directa v√°lida"
  debug:
    msg: "‚Üí {{ zone_check.stdout_lines | last }}"

- name: "üîÑ Recargar zonas DNS en BIND9"
  command: rndc reload
  register: rndc_reload
  changed_when: true
  failed_when: false

- name: "‚úÖ Zonas DNS recargadas"
  debug:
    msg: "‚Üí BIND9 ha recargado todas las zonas"

- name: "‚è∏Ô∏è  Esperar a que BIND9 procese las zonas"
  pause:
    seconds: 3

- name: "üß™ Validar resoluci√≥n DNS de gamecenter.local"
  command: "dig @localhost {{ dns_domain_name }} AAAA +short"
  register: dns_test
  changed_when: false
  failed_when: false

- name: "‚úÖ Resultado de prueba DNS"
  debug:
    msg: 
      - "‚Üí Consultando: {{ dns_domain_name }}"
      - "‚Üí Resultado: {{ dns_test.stdout if dns_test.stdout else 'Sin respuesta' }}"

- name: "‚ö†Ô∏è  Advertencia: DNS no resuelve correctamente"
  debug:
    msg:
      - "‚ùå DNS no est√° resolviendo {{ dns_domain_name }}"
      - "üí° Verifica el archivo: /etc/bind/zones/db.{{ dns_domain_name }}"
      - "üí° Ejecuta: sudo rndc reload"
  when: dns_test.stdout == ""

- name: "üîë Configurar DNS Din√°mico (DDNS)"
  ansible.builtin.include_tasks: configure-ddns.yml
  tags: [dns, ddns]

- name: "üîç Verificar configuraci√≥n antes de reiniciar"
  command: named-checkconf
  register: final_check
  changed_when: false
  failed_when: final_check.rc != 0
  become: true

- name: "‚úÖ Configuraci√≥n v√°lida, reiniciando BIND9"
  debug:
    msg: "‚Üí named-checkconf: OK, procediendo a reiniciar"

- name: "üîÑ Reiniciar BIND9 despu√©s de configurar DDNS"
  systemd:
    name: bind9
    state: restarted
  become: true
  register: bind_restart
  failed_when: false

- name: "‚è∏Ô∏è  Esperar a que BIND9 se estabilice"
  pause:
    seconds: 5

- name: "üîç Verificar que BIND9 est√° corriendo"
  systemd:
    name: bind9
    state: started
  become: true
  register: bind_status

- name: "‚ùå BIND9 fall√≥ al iniciar - Intentando de nuevo"
  block:
    - name: "Ver logs de error"
      command: journalctl -xeu bind9 --no-pager -n 50
      register: bind_logs
      changed_when: false
    
    - name: "Mostrar error"
      debug:
        msg: "{{ bind_logs.stdout_lines }}"
    
    - name: "Limpiar y reintentar"
      shell: |
        systemctl stop bind9
        rm -f /var/run/named/named.pid
        systemctl start bind9
      become: true
      register: bind_retry
    
    - name: "Verificar despu√©s de reintentar"
      systemd:
        name: bind9
        state: started
      become: true
  when: bind_status.failed is defined and bind_status.failed

# Scripts de sincronizaci√≥n DHCP-DNS (comentados - no son necesarios con DDNS)
# - name: "üìã Copiar script de sincronizaci√≥n DHCP-DNS"
#   copy:
#     src: "{{ playbook_dir }}/../../scripts/dhcp-dns-sync.sh"
#     dest: /usr/local/bin/dhcp-dns-sync.sh
#     owner: root
#     group: root
#     mode: '0755'
#   become: true

# - name: "üìã Copiar script de sincronizaci√≥n mejorado"
#   copy:
#     src: "{{ playbook_dir }}/../../scripts/sync-dhcp-to-dns.sh"
#     dest: /usr/local/bin/sync-dhcp-to-dns.sh
#     owner: root
#     group: root
#     mode: '0755'
#   become: true

# - name: "‚è∞ Configurar sincronizaci√≥n autom√°tica DHCP ‚Üí DNS (cada 2 minutos)"
#   cron:
#     name: "Sincronizar clientes DHCP con DNS"
#     minute: "*/2"
#     job: "/usr/local/bin/sync-dhcp-to-dns.sh > /dev/null 2>&1"
#     user: root
#     state: present
#   become: true

# DNS64 ya est√° configurado en el template named.conf.options.j2
# No necesitamos el blockinfile que sobrescribe la configuraci√≥n
# - name: "üåê Configurar DNS64"
#   ansible.builtin.include_tasks: dns64.yml
#   tags: [dns, dns64]

- name: "üîç Verificar si ufw est√° instalado"
  ansible.builtin.command: which ufw
  register: ufw_check
  failed_when: false
  changed_when: false
  become: true

- name: "üõ°Ô∏è  Abrir puertos DNS en firewall (ufw)"
  community.general.ufw:
    rule: allow
    port: "53"
    proto: "{{ item }}"
  loop:
    - tcp
    - udp
  when: 
    - ansible_os_family == "Debian"
    - ufw_check.rc == 0
  become: true

- name: "‚ö†Ô∏è  UFW no instalado, saltando configuraci√≥n de firewall"
  ansible.builtin.debug:
    msg: "‚Üí UFW no est√° instalado. Los puertos DNS deben abrirse manualmente o con otro firewall."
  when: ufw_check.rc != 0