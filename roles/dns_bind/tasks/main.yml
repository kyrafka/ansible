---
# InstalaciÃ³n y configuraciÃ³n de BIND9 para DNS

- name: "Actualizar cachÃ© de apt"
  apt:
    update_cache: yes
    cache_valid_time: 3600
  retries: 3
  delay: 10
  register: apt_update
  until: apt_update is success

- name: "Instalar BIND9 y herramientas DNS"
  apt:
    name:
      - bind9
      - bind9utils
      - bind9-doc
      - dnsutils
    state: present
  retries: 3
  delay: 10

- name: "Crear directorio para zonas DNS"
  file:
    path: /etc/bind/zones
    state: directory
    owner: bind
    group: bind
    mode: '0755'

- name: "Crear directorio para logs de BIND"
  file:
    path: /var/log/named
    state: directory
    owner: bind
    group: bind
    mode: '0755'

- name: "Configurar named.conf principal"
  template:
    src: named.conf.j2
    dest: /etc/bind/named.conf
    owner: root
    group: bind
    mode: '0644'
    backup: yes
  notify: restart bind9

- name: "Configurar named.conf.options"
  template:
    src: named.conf.options.j2
    dest: /etc/bind/named.conf.options
    owner: root
    group: bind
    mode: '0644'
    backup: yes
  notify: restart bind9

- name: "Configurar named.conf.local"
  template:
    src: named.conf.local.j2
    dest: /etc/bind/named.conf.local
    owner: root
    group: bind
    mode: '0644'
    backup: yes
  notify: restart bind9

- name: "Crear zona directa para el dominio"
  template:
    src: db.domain.j2
    dest: "/etc/bind/zones/db.{{ dns_domain_name }}"
    owner: bind
    group: bind
    mode: '0644'
    backup: yes
  notify: restart bind9

- name: "Crear zona inversa IPv6"
  template:
    src: db.ipv6.reverse.j2
    dest: "/etc/bind/zones/db.{{ dns_ipv6_reverse_zone }}"
    owner: bind
    group: bind
    mode: '0644'
    backup: yes
  notify: restart bind9

- name: "Configurar logrotate para BIND"
  template:
    src: bind-logrotate.j2
    dest: /etc/logrotate.d/bind9
    owner: root
    group: root
    mode: '0644'

- name: "Habilitar y iniciar servicio BIND9"
  systemd:
    name: bind9
    enabled: yes
    state: started

- name: "âœ”ï¸  Verificar configuraciÃ³n de BIND"
  command: named-checkconf
  register: bind_config_check
  changed_when: false
  failed_when: bind_config_check.rc != 0

- name: "âœ… ConfiguraciÃ³n de BIND vÃ¡lida"
  debug:
    msg: "â†’ named-checkconf: OK"

- name: "âœ”ï¸  Verificar zona directa"
  command: "named-checkzone {{ dns_domain_name }} /etc/bind/zones/db.{{ dns_domain_name }}"
  register: zone_check
  changed_when: false
  failed_when: zone_check.rc != 0

- name: "âœ… Zona directa vÃ¡lida"
  debug:
    msg: "â†’ {{ zone_check.stdout_lines | last }}"

- name: "ğŸ”„ Recargar zonas DNS en BIND9"
  command: rndc reload
  register: rndc_reload
  changed_when: true
  failed_when: false

- name: "âœ… Zonas DNS recargadas"
  debug:
    msg: "â†’ BIND9 ha recargado todas las zonas"

- name: "â¸ï¸  Esperar a que BIND9 procese las zonas"
  pause:
    seconds: 3

- name: "ğŸ§ª Validar resoluciÃ³n DNS de gamecenter.local"
  command: "dig @localhost {{ dns_domain_name }} AAAA +short"
  register: dns_test
  changed_when: false
  failed_when: false

- name: "âœ… Resultado de prueba DNS"
  debug:
    msg: 
      - "â†’ Consultando: {{ dns_domain_name }}"
      - "â†’ Resultado: {{ dns_test.stdout if dns_test.stdout else 'Sin respuesta' }}"

- name: "âš ï¸  Advertencia: DNS no resuelve correctamente"
  debug:
    msg:
      - "âŒ DNS no estÃ¡ resolviendo {{ dns_domain_name }}"
      - "ğŸ’¡ Verifica el archivo: /etc/bind/zones/db.{{ dns_domain_name }}"
      - "ğŸ’¡ Ejecuta: sudo rndc reload"
  when: dns_test.stdout == ""

- name: "ğŸŒ Configurar DNS64"
  ansible.builtin.include_tasks: dns64.yml
  tags: [dns, dns64]

- name: "ğŸ” Verificar si ufw estÃ¡ instalado"
  ansible.builtin.command: which ufw
  register: ufw_check
  failed_when: false
  changed_when: false
  become: true

- name: "ğŸ›¡ï¸  Abrir puertos DNS en firewall (ufw)"
  community.general.ufw:
    rule: allow
    port: "53"
    proto: "{{ item }}"
  loop:
    - tcp
    - udp
  when: 
    - ansible_os_family == "Debian"
    - ufw_check.rc == 0
  become: true

- name: "âš ï¸  UFW no instalado, saltando configuraciÃ³n de firewall"
  ansible.builtin.debug:
    msg: "â†’ UFW no estÃ¡ instalado. Los puertos DNS deben abrirse manualmente o con otro firewall."
  when: ufw_check.rc != 0