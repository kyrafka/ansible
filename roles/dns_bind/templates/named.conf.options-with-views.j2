# Configuración común
acl clients-ipv6 {
    {{ dns_network_ipv6 }};
    localhost;
};

# Opciones globales
options {
    directory "/var/cache/bind";
    
    // Configuración de seguridad
    dnssec-validation auto;
    
    // Configuración de red
    listen-on-v6 { any; };
    listen-on { any; };
    
    // Configuración de versión (seguridad)
    version none;
    hostname none;
    server-id none;
    
    // Configuración para zonas dinámicas
    ixfr-from-differences yes;
};

// Vista para clientes IPv6 - FILTRAR AAAA de internet
view "ipv6-clients" {
    match-clients { clients-ipv6; };
    
    // Forwarders
    forwarders {
{% for forwarder in dns_forwarders %}
        {{ forwarder }};
{% endfor %}
    };
    
    // DNS64: Traduce respuestas IPv4 a IPv6
    dns64 64:ff9b::/96 {
        clients { any; };
        mapped { any; };
        exclude { {{ dns_network_ipv6 }}; ::ffff:0:0/96; };
        recursive-only yes;
        break-dnssec yes;
    };
    
    // CLAVE: Filtrar respuestas AAAA de internet
    // Solo permite AAAA de tu red local
    filter-aaaa-on-v4 break-dnssec;
    
    // Permitir consultas
    allow-query { any; };
    
    // Permitir recursión
    recursion yes;
    allow-recursion { any; };
    
    // Configuración de transferencias
    allow-transfer { none; };
    
    // Configuración de notificaciones
    notify no;
    
    // Incluir zonas locales
    include "/etc/bind/named.conf.local";
};

// Configuración de logging
{% if dns_log_queries %}
logging {
    channel query_log {
        file "{{ dns_log_file }}" versions 3 size 5m;
        severity {{ dns_log_level }};
        print-time yes;
        print-category yes;
    };
    
    category queries { query_log; };
    category security { query_log; };
    category lame-servers { null; };
};
{% endif %}
