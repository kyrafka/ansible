---
# Playbook para crear UNA VM Ubuntu Desktop con 3 usuarios (admin, auditor, cliente)
# Uso: ansible-playbook create-vm-ubuntu-desktop.yml

- name: Crear VM Ubuntu Desktop en ESXi
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - group_vars/all.yml
    - group_vars/all.vault.yml
    - group_vars/ubpc.yml

  vars:
    vm_name: "Ubuntu-Desktop-GameCenter"
    vm_memory: 8192
    vm_cpus: 4
    vm_disk_size_gb: 40

  tasks:
    - name: "ğŸ“‹ ConfiguraciÃ³n de la VM"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ® Creando VM Ubuntu Desktop GameCenter"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Nombre: {{ vm_name }}"
          - "Memoria: {{ vm_memory }} MB ({{ vm_memory // 1024 }} GB)"
          - "CPUs: {{ vm_cpus }}"
          - "Disco: {{ vm_disk_size_gb }} GB"
          - "Red: {{ vmware.internal_network_name }}"
          - ""
          - "Esta VM tendrÃ¡ 3 usuarios:"
          - "  1. admin    - Administrador (sudo completo)"
          - "  2. auditor  - Auditor (solo lectura)"
          - "  3. gamer01  - Cliente/Gamer (sin privilegios)"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: "ğŸ”Œ Verificar conexiÃ³n con ESXi"
      uri:
        url: "https://{{ vault_vcenter_hostname }}:{{ vault_vcenter_port }}/ui/"
        method: GET
        validate_certs: no
        timeout: 10
      register: vcenter_response
      failed_when: false
      ignore_errors: true

    - name: "âŒ Error de conexiÃ³n - Deteniendo playbook"
      fail:
        msg: |
          âŒ No se pudo conectar a ESXi
          
          Host: {{ vault_vcenter_hostname }}
          Puerto: {{ vault_vcenter_port }}
          
          Verifica:
          1. ESXi estÃ¡ encendido
          2. La IP es correcta ({{ vault_vcenter_hostname }})
          3. El puerto es correcto ({{ vault_vcenter_port }})
          4. Hay conectividad de red: ping {{ vault_vcenter_hostname }}
      when: vcenter_response.status is not defined or vcenter_response.status != 200

    - name: "âœ… ConexiÃ³n verificada"
      debug:
        msg: "âœ… Conectado a ESXi en {{ vault_vcenter_hostname }}:{{ vault_vcenter_port }}"
      when: vcenter_response.status is defined and vcenter_response.status == 200

    - name: "ğŸ” Verificar si la VM ya existe"
      community.vmware.vmware_guest_info:
        hostname: "{{ vault_vcenter_hostname }}"
        username: "{{ vault_vcenter_username }}"
        password: "{{ vault_vcenter_password }}"
        port: "{{ vault_vcenter_port }}"
        validate_certs: no
        datacenter: "{{ vmware.datacenter }}"
        name: "{{ vm_name }}"
      register: vm_info
      ignore_errors: true

    - name: "âš ï¸  VM ya existe"
      debug:
        msg:
          - "âš ï¸  La VM '{{ vm_name }}' ya existe"
          - "Estado: {{ vm_info.instance.hw_power_status | default('unknown') }}"
          - "Saltando creaciÃ³n..."
      when: vm_info.instance is defined

    - name: "ğŸš€ Crear VM Ubuntu Desktop"
      community.vmware.vmware_guest:
        hostname: "{{ vault_vcenter_hostname }}"
        username: "{{ vault_vcenter_username }}"
        password: "{{ vault_vcenter_password }}"
        port: "{{ vault_vcenter_port }}"
        validate_certs: no
        datacenter: "{{ vmware.datacenter }}"
        folder: "{{ vmware.folder }}"
        name: "{{ vm_name }}"
        state: poweredon
        guest_id: ubuntu64Guest
        annotation: "VM Ubuntu Desktop con 3 usuarios: admin, auditor, gamer01"
        hardware:
          memory_mb: "{{ vm_memory }}"
          num_cpus: "{{ vm_cpus }}"
          scsi: paravirtual
          boot_firmware: efi
        networks:
          - name: "{{ vmware.internal_network_name }}"
            device_type: vmxnet3
        disk:
          - size_gb: "{{ vm_disk_size_gb }}"
            type: thin
            datastore: "{{ vmware.datastore }}"
        cdrom:
          - controller_number: 0
            unit_number: 0
            type: iso
            iso_path: "[{{ vmware.datastore }}] ISOs/ubuntu-22.04-desktop-amd64.iso"
            state: present
        wait_for_ip_address: false
      register: vm_creation
      when: vm_info.instance is not defined

    - name: "âœ… VM creada exitosamente"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… VM '{{ vm_name }}' creada exitosamente"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Estado: {{ vm_creation.instance.hw_power_status | default('poweredOn') }}"
          - "Red: {{ vmware.internal_network_name }}"
          - ""
          - "ğŸ“ SIGUIENTE PASO: Instalar Ubuntu Desktop"
          - ""
          - "1. Abre la consola de la VM en vSphere"
          - "2. Instala Ubuntu Desktop"
          - "3. Durante la instalaciÃ³n, crea el usuario INICIAL:"
          - "   - Nombre: Administrador"
          - "   - Usuario: admin"
          - "   - ContraseÃ±a: {{ vault_ubuntu_desktop_admin_password }}"
          - "   - Hostname: ubuntu-desktop-gamecenter"
          - ""
          - "4. DespuÃ©s de instalar, ejecuta:"
          - "   ansible-playbook configure-ubuntu-desktop.yml"
          - ""
          - "   Esto crearÃ¡ los otros 2 usuarios:"
          - "   - auditor (contraseÃ±a: {{ vault_ubuntu_desktop_auditor_password }})"
          - "   - gamer01 (contraseÃ±a: {{ vault_ubuntu_desktop_cliente_password }})"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      when: vm_creation.changed | default(false)
