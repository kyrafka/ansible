---
# Playbook para crear VM Ubuntu en tu ESXi especÃ­fico
- name: Crear VM Ubuntu GameCenter en ESXi
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - group_vars/all.yml
    - group_vars/all.vault.yml
    - esxi-config.yml
  
  pre_tasks:
    - name: Verificar conectividad con ESXi
      uri:
        url: "https://{{ vmware.vcenter_hostname }}:{{ vmware.port }}/ui/"
        method: GET
        validate_certs: false
        timeout: 10
      register: esxi_check
      ignore_errors: true
    
    - name: Mostrar estado de ESXi
      debug:
        msg: |
          ğŸ–¥ï¸ ESXi Status: {{ 'ACCESIBLE' if esxi_check.status == 200 else 'NO ACCESIBLE' }}
          ğŸ“¡ URL: https://{{ vmware.vcenter_hostname }}:{{ vmware.port }}
          ğŸ‘¤ Usuario: {{ vmware.vcenter_username }}
    
    - name: Verificar dependencias Python
      pip:
        name:
          - pyvmomi>=7.0.0
          - requests
        state: present
      ignore_errors: true
    
    - name: Instalar colecciÃ³n VMware si no existe
      ansible.builtin.shell: |
        ansible-galaxy collection install community.vmware --force
      ignore_errors: true

  tasks:
    - name: Mostrar configuraciÃ³n de la VM a crear
      debug:
        msg: |
          ğŸš€ CREANDO VM UBUNTU EN ESXi
          
          ğŸ“‹ ConfiguraciÃ³n:
          - Nombre: {{ vmware.vm_name }}
          - ESXi: {{ vmware.vcenter_hostname }}:{{ vmware.port }}
          - Datastore: {{ vmware.datastore }}
          - RAM: {{ vmware.memory }}MB ({{ (vmware.memory/1024)|int }}GB)
          - CPU: {{ vmware.cpus }} cores
          - Disco: {{ (vmware.disk_size_mb/1024)|int }}GB
          - Red: {{ vmware.network_name }}
          - ISO: {{ vmware.iso_path }}
          
          ğŸŒ Red IPv6:
          - Red: {{ network_config.ipv6_network }}
          - IP objetivo: {{ network_config.target_ip }}
          - Gateway: {{ network_config.ipv6_gateway }}
    
    - name: Crear VM Ubuntu con servicios IPv6
      include_role:
        name: vmware
      tags: create_vm
    
    - name: Esperar a que la VM estÃ© completamente lista
      pause:
        prompt: |
          
          â³ La VM se estÃ¡ creando e instalando automÃ¡ticamente...
          
          ğŸ“‹ Mientras esperas, puedes:
          1. Monitorear desde ESXi: https://{{ vmware.vcenter_hostname }}:{{ vmware.port }}
          2. La instalaciÃ³n tomarÃ¡ 10-15 minutos
          3. Presiona ENTER cuando veas que la VM tiene IP asignada
        
    - name: Verificar que la VM estÃ¡ lista para configuraciÃ³n
      community.vmware.vmware_guest_info:
        hostname: "{{ vmware.vcenter_hostname }}"
        username: "{{ vmware.vcenter_username }}"
        password: "{{ vmware.vcenter_password }}"
        port: "{{ vmware.port }}"
        validate_certs: false
        name: "{{ vmware.vm_name }}"
      register: vm_final_info
    
    - name: Mostrar informaciÃ³n final de la VM
      debug:
        msg: |
          ğŸ‰ Â¡VM CREADA EXITOSAMENTE!
          
          ğŸ“Š InformaciÃ³n de la VM:
          - Nombre: {{ vmware.vm_name }}
          - Estado: {{ vm_final_info.instance.hw_power_status }}
          - IP IPv4: {{ vm_final_info.instance.ipv4 | default('Pendiente') }}
          - IP IPv6: {{ vm_final_info.instance.ipv6 | default('Pendiente') }}
          - SO: {{ vm_final_info.instance.hw_guest_full_name | default('Ubuntu 24.04') }}
          
          ğŸ”‘ Credenciales:
          - Usuario: ubuntu
          - Password: ubuntu123
          - SSH: Habilitado automÃ¡ticamente
          
          ğŸ“‹ PRÃ“XIMOS PASOS:
          1. Actualizar inventory/hosts.ini con la IP real
          2. Ejecutar: ./scripts/deploy-to-server.sh
          3. Configurar servicios IPv6 automÃ¡ticamente
          
          ğŸ’¡ La VM estÃ¡ lista para recibir la configuraciÃ³n de servicios

  post_tasks:
    - name: Crear script de conexiÃ³n rÃ¡pida
      copy:
        content: |
          #!/bin/bash
          # Script para conectar a la nueva VM
          echo "ğŸ”— Conectando a {{ vmware.vm_name }}..."
          {% if vm_final_info.instance.ipv4 is defined %}
          ssh -o StrictHostKeyChecking=no ubuntu@{{ vm_final_info.instance.ipv4 | first }}
          {% else %}
          echo "âš ï¸ IP no disponible aÃºn. Verifica desde ESXi."
          {% endif %}
        dest: "./connect-to-vm.sh"
        mode: '0755'
      when: vm_final_info.instance.ipv4 is defined