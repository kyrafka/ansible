---
# Playbook para configurar Ubuntu Desktop localmente antes de desconectar internet
- name: Configurar Ubuntu Desktop (local)
  hosts: localhost
  connection: local
  become: true
  
  vars_files:
    - ../group_vars/all.yml
  
  tasks:
    - name: "ï¿½ DInformaciÃ³n"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ–¥ï¸  Configurando Ubuntu Desktop"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Este playbook prepara la VM para usar solo IPv6"
    
    - name: "ğŸ“¦ Actualizar repositorios e instalar paquetes"
      apt:
        name:
          - nfs-common
          - net-tools
          - curl
          - wget
          - iperf3
          - dnsutils
          - traceroute
          - tcpdump
        state: present
        update_cache: yes
    
    - name: "ğŸ”§ Deshabilitar systemd-resolved"
      systemd:
        name: systemd-resolved
        state: stopped
        enabled: no
    
    - name: "ğŸ“ Configurar DNS del servidor"
      copy:
        content: |
          nameserver 2025:db8:10::2
          search gamecenter.lan
        dest: /etc/resolv.conf
        mode: '0644'
    
    - name: "ğŸ”’ Proteger resolv.conf de cambios"
      file:
        path: /etc/resolv.conf
        attributes: +i
    
    - name: "ğŸ“ Configurar hostname en /etc/hosts"
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
      loop:
        - "127.0.0.1 {{ ansible_hostname }}"
        - "::1 {{ ansible_hostname }}"
    
    - name: "ğŸ“ Crear punto de montaje NFS"
      file:
        path: /mnt/games
        state: directory
        mode: '0755'
    
    - name: "ğŸ”— Configurar montaje NFS automÃ¡tico"
      lineinfile:
        path: /etc/fstab
        line: "[2025:db8:10::2]:/srv/games /mnt/games nfs defaults,_netdev,noauto 0 0"
        state: present
        backup: yes
    
    - name: "ğŸ” Detectar interfaz de red principal"
      shell: ip -o link show | grep -v "lo:" | head -1 | awk '{print $2}' | sed 's/://'
      register: network_interface
      changed_when: false
    
    - name: "ğŸ“‹ Interfaz detectada"
      debug:
        msg: "â†’ Usando interfaz: {{ network_interface.stdout }}"
    
    - name: "ğŸŒ Configurar netplan para DHCP IPv6"
      copy:
        content: |
          network:
            version: 2
            ethernets:
              {{ network_interface.stdout }}:
                dhcp4: false
                dhcp6: true
                accept-ra: true
                nameservers:
                  addresses:
                    - 2025:db8:10::2
                  search:
                    - gamecenter.lan
        dest: /etc/netplan/01-netcfg.yaml
        mode: '0644'
        backup: yes
    
    - name: "ğŸ”„ Aplicar configuraciÃ³n de red"
      command: netplan apply
      changed_when: false
      failed_when: false
    
    - name: "â¸ï¸  Esperar a que la red se estabilice"
      pause:
        seconds: 3
    
    - name: "ğŸ” Detectar gateway IPv6"
      shell: ip -6 route | grep default | awk '{print $3}'
      register: ipv6_gateway
      changed_when: false
    
    - name: "ğŸŒ Agregar ruta para NAT64 (64:ff9b::/96)"
      command: ip -6 route add 64:ff9b::/96 via {{ ipv6_gateway.stdout }} dev {{ network_interface.stdout }}
      changed_when: true
      failed_when: false
    
    - name: "ğŸ§ª Verificar conectividad al servidor"
      command: ping6 -c 3 2025:db8:10::2
      register: ping_result
      changed_when: false
      failed_when: false
    
    - name: "ğŸ§ª Verificar DNS"
      command: dig @2025:db8:10::2 google.com AAAA +short
      register: dns_result
      changed_when: false
      failed_when: false
    
    - name: "âœ… ConfiguraciÃ³n completada"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… Ubuntu Desktop configurado"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "â†’ DNS: 2025:db8:10::2"
          - "â†’ Dominio: gamecenter.lan"
          - "â†’ NFS: Configurado (montar con: sudo mount /mnt/games)"
          - "â†’ Ping al servidor: {{ 'OK' if ping_result.rc == 0 else 'FALLO' }}"
          - "â†’ DNS64: {{ 'OK' if dns_result.stdout else 'FALLO' }}"
          - ""
          - "ğŸ”Œ Ahora puedes desconectar el adaptador de internet"
          - "   y cambiar a la red interna M_s"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
