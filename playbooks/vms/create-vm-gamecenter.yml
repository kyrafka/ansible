---
# Playbook para crear una VM Ubuntu en tu ESXi o vCenter
- name: Crear VM Ubuntu GameCenter en ESXi o vCenter
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - group_vars/all.yml
    - group_vars/all.vault.yml
    - group_vars/ubpc.yml

  tasks:
    - name: Verificar conexión con vCenter / ESXi
      uri:
        url: "https://{{ vault_vcenter_hostname }}:{{ vault_vcenter_port }}/ui/"
        method: GET
        validate_certs: no
      register: vcenter_response
      ignore_errors: true

    - name: Mostrar estado de conexión
      debug:
        msg: >-
          {{ '✅ Conexión exitosa al vCenter/ESXi en ' ~ vault_vcenter_hostname ~ ':' ~ vault_vcenter_port
             if vcenter_response.status is defined and vcenter_response.status == 200
             else '❌ Error al conectar al vCenter/ESXi en ' ~ vault_vcenter_hostname ~ ':' ~ vault_vcenter_port }}

    - name: Crear la VM Ubuntu GameCenter
      community.vmware.vmware_guest:
        hostname: "{{ vault_vcenter_hostname }}"
        username: "{{ vault_vcenter_username }}"
        password: "{{ vault_vcenter_password }}"
        port: "{{ vault_vcenter_port }}"
        validate_certs: no
        datacenter: "{{ vmware.datacenter }}"
        folder: "{{ vmware.folder }}"
        name: "{{ vmware.vm_name }}"
        state: poweredon
        guest_id: "{{ vmware.guest_id }}"
        hardware:
          memory_mb: "{{ vmware.memory }}"
          num_cpus: "{{ vmware.cpus }}"
          scsi: paravirtual
          boot_firmware: "{{ vmware.boot_firmware }}"
        networks:
          - name: "{{ vmware.network_name }}"
            device_type: vmxnet3
          - name: "{{ vmware.internal_network_name }}"
            device_type: vmxnet3
        disk:
          - size_gb: "{{ vmware.disk_size_mb | int // 1024 }}"
            type: thin
            datastore: "{{ vmware.datastore }}"
        cdrom:
          - controller_number: 0
            unit_number: 0
            type: iso
            iso_path: "{{ vmware.iso_path }}"
            state: present
        wait_for_ip_address: false
      register: vm_creation

    - name: Mostrar resumen de la VM creada
      debug:
        msg:
          - "✅ VM '{{ vmware.vm_name }}' creada con éxito en '{{ vmware.datastore }}'."
          - "Red: {{ vmware.network_name }}"
          - "Red IPv6: {{ network_config.ipv6_network }}"
          - "IP del servidor: 2025:db8:10::2"
          - "Gateway: {{ network_config.ipv6_gateway }}"
          - "Estado actual: {{ vm_creation.instance.hw_power_status }}"

    - name: VM creada exitosamente
      debug:
        msg:
          - "✅ VM creada con 2 adaptadores de red"
          - ""
          - "Adaptador 1 (WAN): {{ vmware.network_name }}"
          - "  - Internet por DHCPv4"
          - ""
          - "Adaptador 2 (LAN): {{ vmware.internal_network_name }}"
          - "  - Red interna IPv6: 2025:db8:10::/64"
          - "  - IP del servidor: 2025:db8:10::2"
          - ""
          - "El servidor actuará como router NAT"
          - "Instala Ubuntu manualmente desde vSphere"
