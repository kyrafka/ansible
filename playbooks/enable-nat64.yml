---
# Playbook para habilitar NAT64 (Tayga) en el servidor
# Esto permite que las VMs IPv6 accedan a internet IPv4

- name: Habilitar NAT64 para acceso a internet
  hosts: localhost
  connection: local
  become: true
  
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/all.vault.yml
  
  vars:
    wan_interface: "ens33"
    lan_interface: "ens34"
  
  tasks:
    - name: "ğŸ“‹ InformaciÃ³n del sistema"
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸŒ Habilitando NAT64 (Tayga)"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "â†’ WAN: {{ wan_interface }} (internet IPv4)"
          - "â†’ LAN: {{ lan_interface }} (red interna IPv6)"
          - "â†’ Prefijo NAT64: 64:ff9b::/96"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: "ğŸ”§ Aplicar configuraciÃ³n NAT64"
      ansible.builtin.include_role:
        name: nat64_tayga
      tags: nat64
    
    - name: "ğŸ”„ Reiniciar BIND9 para aplicar DNS64"
      ansible.builtin.systemd:
        name: named
        state: restarted
      become: true
    
    - name: "â³ Esperar a que BIND9 estÃ© listo"
      ansible.builtin.pause:
        seconds: 3
    
    - name: "ğŸ” Verificar DNS64"
      ansible.builtin.shell: |
        dig @localhost google.com AAAA +short
      register: dns64_test
      changed_when: false
      failed_when: false
    
    - name: "ğŸ“‹ Resultado DNS64"
      ansible.builtin.debug:
        msg:
          - "â†’ Consulta: google.com AAAA"
          - "â†’ Respuesta: {{ dns64_test.stdout_lines }}"
          - "â†’ {{ 'DNS64 funcionando âœ“' if '64:ff9b::' in dns64_test.stdout else 'DNS64 no activo (normal si google tiene IPv6 nativo)' }}"
    
    - name: "ğŸ” Verificar DNS64 con sitio solo IPv4"
      ansible.builtin.shell: |
        dig @localhost ipv4.google.com AAAA +short
      register: dns64_ipv4_test
      changed_when: false
      failed_when: false
    
    - name: "ğŸ“‹ Resultado DNS64 (sitio IPv4)"
      ansible.builtin.debug:
        msg:
          - "â†’ Consulta: ipv4.google.com AAAA"
          - "â†’ Respuesta: {{ dns64_ipv4_test.stdout_lines }}"
          - "â†’ {{ 'DNS64 funcionando âœ“' if '64:ff9b::' in dns64_ipv4_test.stdout else 'Verificar configuraciÃ³n' }}"
    
    - name: "ğŸ” Verificar estado de Tayga"
      ansible.builtin.command: systemctl status tayga
      register: tayga_status
      changed_when: false
      failed_when: false
    
    - name: "ğŸ“‹ Estado de Tayga"
      ansible.builtin.debug:
        msg: "{{ tayga_status.stdout_lines }}"
    
    - name: "ğŸ” Verificar interfaz nat64"
      ansible.builtin.command: ip addr show nat64
      register: nat64_interface
      changed_when: false
      failed_when: false
    
    - name: "ğŸ“‹ Interfaz nat64"
      ansible.builtin.debug:
        msg: "{{ nat64_interface.stdout_lines }}"
    
    - name: "ğŸ” Verificar rutas NAT64"
      ansible.builtin.shell: |
        echo "=== Rutas IPv6 ==="
        ip -6 route | grep 64:ff9b
        echo ""
        echo "=== Rutas IPv4 ==="
        ip -4 route | grep 192.168.255
      register: nat64_routes
      changed_when: false
      failed_when: false
    
    - name: "ğŸ“‹ Rutas NAT64"
      ansible.builtin.debug:
        msg: "{{ nat64_routes.stdout_lines }}"
    
    - name: "âœ… ConfiguraciÃ³n completada"
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… NAT64 + DNS64 configurado"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ§ª Pruebas desde tu VM Ubuntu Desktop:"
          - ""
          - "1. Verificar DNS64:"
          - "   dig google.com AAAA"
          - "   (Debe mostrar direcciones 64:ff9b::...)"
          - ""
          - "2. Hacer ping a travÃ©s de NAT64:"
          - "   ping6 64:ff9b::8.8.8.8"
          - "   (Esto es 8.8.8.8 traducido a IPv6)"
          - ""
          - "3. Probar navegaciÃ³n:"
          - "   ping6 google.com"
          - "   curl -6 http://google.com"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Si todo funciona, tus VMs tendrÃ¡n internet"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
