---
# Playbook para configurar proxy en VMs Ubuntu Desktop
# Esto permite que apt funcione en VMs IPv6-only

- name: Configurar proxy en VM Ubuntu Desktop
  hosts: ubuntu_desktops
  become: true
  
  vars:
    proxy_server: "http://[2025:db8:10::2]:3128"
  
  tasks:
    - name: "ğŸ“‹ InformaciÃ³n"
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸŒ Configurando proxy en {{ inventory_hostname }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "â†’ Proxy: {{ proxy_server }}"
    
    - name: "ğŸ“ Configurar proxy para APT"
      ansible.builtin.copy:
        content: |
          Acquire::http::Proxy "{{ proxy_server }}";
          Acquire::https::Proxy "{{ proxy_server }}";
        dest: /etc/apt/apt.conf.d/proxy.conf
        owner: root
        group: root
        mode: '0644'
    
    - name: "âœ“ Proxy APT configurado"
      ansible.builtin.debug:
        msg: "â†’ APT usarÃ¡ el proxy del servidor"
    
    - name: "ğŸ“ Configurar proxy para el sistema"
      ansible.builtin.blockinfile:
        path: /etc/environment
        block: |
          http_proxy="{{ proxy_server }}"
          https_proxy="{{ proxy_server }}"
          HTTP_PROXY="{{ proxy_server }}"
          HTTPS_PROXY="{{ proxy_server }}"
          no_proxy="localhost,127.0.0.1,::1,2025:db8:10::/64"
          NO_PROXY="localhost,127.0.0.1,::1,2025:db8:10::/64"
        marker: "# {mark} ANSIBLE MANAGED PROXY CONFIG"
    
    - name: "âœ“ Proxy del sistema configurado"
      ansible.builtin.debug:
        msg: "â†’ Variables de entorno configuradas"
    
    - name: "ğŸ”„ Actualizar cache de APT"
      ansible.builtin.apt:
        update_cache: yes
      environment:
        http_proxy: "{{ proxy_server }}"
        https_proxy: "{{ proxy_server }}"
    
    - name: "âœ“ Cache actualizado"
      ansible.builtin.debug:
        msg: "â†’ APT puede descargar paquetes"
    
    - name: "ğŸ“¦ Instalar OpenSSH Server"
      ansible.builtin.apt:
        name: openssh-server
        state: present
      environment:
        http_proxy: "{{ proxy_server }}"
        https_proxy: "{{ proxy_server }}"
    
    - name: "ğŸ”„ Habilitar y iniciar SSH"
      ansible.builtin.systemd:
        name: ssh
        enabled: yes
        state: started
    
    - name: "âœ“ SSH instalado y activo"
      ansible.builtin.debug:
        msg: "â†’ Puedes conectarte por SSH ahora"
    
    - name: "âœ… ConfiguraciÃ³n completada"
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… VM configurada correctamente"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "â†’ Proxy: Configurado"
          - "â†’ APT: Funcionando"
          - "â†’ SSH: Activo"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
