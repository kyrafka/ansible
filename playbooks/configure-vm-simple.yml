---
# Playbook simplificado para configurar Ubuntu Desktop
# Sin dependencias de roles complejos

- name: Configurar Ubuntu Desktop
  hosts: ubuntu_desktops
  become: true
  
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/all.vault.yml
  
  tasks:
    - name: "ğŸ“‹ InformaciÃ³n"
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ–¥ï¸  Configurando {{ inventory_hostname }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: "ğŸ”„ Actualizar sistema"
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
        autoclean: yes
    
    - name: "ğŸ“¦ Instalar paquetes base"
      ansible.builtin.apt:
        name:
          - vim
          - curl
          - wget
          - git
          - htop
          - nfs-common
          - ufw
        state: present
    
    - name: "ğŸ‘¥ Crear grupo pcgamers"
      ansible.builtin.group:
        name: pcgamers
        gid: 3000
        state: present
    
    - name: "ğŸ‘¤ Crear usuario admin"
      ansible.builtin.user:
        name: admin
        password: "{{ vault_ubuntu_desktop_admin_password | password_hash('sha512') }}"
        groups: [sudo, adm, pcgamers]
        shell: /bin/bash
        create_home: yes
    
    - name: "ğŸ‘¤ Crear usuario auditor"
      ansible.builtin.user:
        name: auditor
        password: "{{ vault_ubuntu_desktop_auditor_password | password_hash('sha512') }}"
        groups: [adm, pcgamers]
        shell: /bin/bash
        create_home: yes
    
    - name: "ğŸ‘¤ Crear usuario gamer01"
      ansible.builtin.user:
        name: gamer01
        password: "{{ vault_ubuntu_desktop_cliente_password | password_hash('sha512') }}"
        groups: [pcgamers]
        shell: /bin/bash
        create_home: yes
    
    - name: "ğŸ” Configurar sudo sin contraseÃ±a para admin"
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/admin
        line: "admin ALL=(ALL) NOPASSWD:ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
    
    - name: "ğŸ“ Crear directorios"
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: '/srv/admin', owner: 'admin', group: 'admin', mode: '0755' }
        - { path: '/srv/audits', owner: 'auditor', group: 'auditor', mode: '0755' }
        - { path: '/srv/games', owner: 'root', group: 'pcgamers', mode: '0775' }
        - { path: '/mnt/games', owner: 'root', group: 'pcgamers', mode: '0775' }
    
    - name: "ğŸ”¥ Configurar firewall"
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
      loop:
        - '22'
        - '80'
        - '443'
    
    - name: "ğŸ”¥ Habilitar firewall"
      community.general.ufw:
        state: enabled
    
    - name: "ğŸ” Configurar SSH (solo admin)"
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^AllowUsers'
        line: 'AllowUsers admin administrador'
        state: present
      notify: reiniciar ssh
    
    - name: "âœ… ConfiguraciÃ³n completada"
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… {{ inventory_hostname }} configurado"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "â†’ Usuarios: admin, auditor, gamer01"
          - "â†’ ContraseÃ±as: (ver vault)"
          - "â†’ Firewall: activo"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  handlers:
    - name: reiniciar ssh
      ansible.builtin.systemd:
        name: ssh
        state: restarted
