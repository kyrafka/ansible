---
- name: Crear VM Windows 11 con rol específico
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/all.vault.yml
  
  vars_prompt:
    - name: vm_name
      prompt: "Nombre de la VM"
      private: false
      
    - name: vm_role
      prompt: "Rol (admin/auditor/cliente)"
      private: false
      default: "cliente"
  
  vars:
    # Recursos según rol
    role_resources:
      admin:
        cpu: 2
        ram: 4096
        disk: 50
      auditor:
        cpu: 2
        ram: 3072
        disk: 30
      cliente:
        cpu: 2
        ram: 4096
        disk: 40
    
    # ISO de Windows 11
    iso_path: "[datastore1] Win11_24H2_Spanish_Mexico_x64.iso"
    network_name: "M_vm's"  # Red interna donde está el DHCP/DNS (ens34 del servidor)
  
  tasks:
    - name: Validar rol
      ansible.builtin.assert:
        that:
          - vm_role in ['admin', 'auditor', 'cliente']
        fail_msg: "Rol debe ser: admin, auditor o cliente"
    
    - name: Crear VM Windows 11
      community.vmware.vmware_guest:
        hostname: "{{ vault_vcenter_hostname }}"
        username: "{{ vault_vcenter_username }}"
        password: "{{ vault_vcenter_password }}"
        port: "{{ vault_vcenter_port }}"
        validate_certs: false
        datacenter: "ha-datacenter"
        folder: "/ha-datacenter/vm"
        name: "{{ vm_name }}"
        state: poweredon
        guest_id: windows9_64Guest
        
        hardware:
          memory_mb: "{{ role_resources[vm_role].ram }}"
          num_cpus: "{{ role_resources[vm_role].cpu }}"
          scsi: lsilogicsas
          boot_firmware: efi
          secure_boot: true
          version: 14
        
        disk:
          - size_gb: "{{ role_resources[vm_role].disk }}"
            type: thin
            datastore: "datastore1"
        
        networks:
          - name: "{{ network_name }}"
            device_type: vmxnet3
        
        cdrom:
          - controller_number: 0
            unit_number: 0
            type: iso
            iso_path: "{{ iso_path }}"
            state: present
        
        customvalues:
          - key: "guestinfo.role"
            value: "{{ vm_role }}"
      
      register: vm_created
    
    - name: Mostrar información de la VM
      ansible.builtin.debug:
        msg:
          - "VM creada: {{ vm_name }}"
          - "Rol: {{ vm_role }}"
          - "CPU: {{ role_resources[vm_role].cpu }}"
          - "RAM: {{ role_resources[vm_role].ram }} MB"
          - "Disco: {{ role_resources[vm_role].disk }} GB"
          - "Red: {{ network_name }}"
          - ""
          - "Siguiente paso:"
          - "1. Instalar Windows 11 desde la ISO"
          - "2. Habilitar WinRM (ver README)"
          - "3. Agregar a inventory/hosts.ini en [windows_desktops]"
          - "4. Ejecutar: ansible-playbook playbooks/configure-windows-role.yml --limit {{ vm_name }}"
