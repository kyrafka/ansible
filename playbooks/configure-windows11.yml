---
# ════════════════════════════════════════════════════════════════
# Playbook: Configurar VM Windows 11
# ════════════════════════════════════════════════════════════════
# 
# Requisitos previos:
# 1. Windows 11 instalado
# 2. SSH habilitado (ejecutar setup-ssh-windows.ps1)
# 3. IPv6 configurado
# 4. VM agregada al inventario
#
# Uso:
#   ansible-playbook -i inventory/hosts.ini playbooks/configure-windows11.yml
#
# ════════════════════════════════════════════════════════════════

- name: Configurar VM Windows 11
  hosts: windows_vms
  gather_facts: yes
  
  vars:
    windows_users:
      - name: admin
        password: "123"
        groups: ["Administrators"]
        description: "Administrador del sistema"
      
      - name: auditor
        password: "123"
        groups: ["Performance Log Users", "Event Log Readers"]
        description: "Auditor - Solo lectura"
      
      - name: gamer01
        password: "123"
        groups: ["Users"]
        description: "Usuario gamer"
    
    shared_folders:
      - path: "C:\\Shared"
      - path: "C:\\Shared\\Admin"
        owner: admin
      - path: "C:\\Shared\\Audits"
        owner: auditor
      - path: "C:\\Shared\\Games"
        owner: gamer01

  tasks:
    # ════════════════════════════════════════════════════════════
    # 1. Verificar conectividad
    # ════════════════════════════════════════════════════════════
    
    - name: Verificar que Windows responde
      win_ping:
      register: ping_result
    
    - name: Mostrar información del sistema
      debug:
        msg: |
          ✅ Conectado a {{ inventory_hostname }}
          OS: {{ ansible_os_name }}
          Versión: {{ ansible_distribution_version }}
          IPv6: {{ ansible_default_ipv6.address | default('No configurado') }}
    
    # ════════════════════════════════════════════════════════════
    # 2. Crear usuarios
    # ════════════════════════════════════════════════════════════
    
    - name: Crear usuarios de Windows
      win_user:
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        state: present
        groups: "{{ item.groups }}"
        description: "{{ item.description }}"
        password_never_expires: yes
        user_cannot_change_password: no
      loop: "{{ windows_users }}"
      when: item.name != 'admin'  # admin ya existe
    
    - name: Actualizar contraseña de admin
      win_user:
        name: admin
        password: "123"
        state: present
        groups: ["Administrators"]
    
    # ════════════════════════════════════════════════════════════
    # 3. Crear carpetas compartidas
    # ════════════════════════════════════════════════════════════
    
    - name: Crear carpetas compartidas
      win_file:
        path: "{{ item.path }}"
        state: directory
      loop: "{{ shared_folders }}"
    
    - name: Configurar permisos de carpetas
      win_shell: |
        icacls "{{ item.path }}" /grant "{{ item.owner }}:F"
      loop: "{{ shared_folders }}"
      when: item.owner is defined
    
    # ════════════════════════════════════════════════════════════
    # 4. Configurar firewall
    # ════════════════════════════════════════════════════════════
    
    - name: Habilitar firewall
      win_firewall:
        state: enabled
        profiles:
          - Domain
          - Private
          - Public
    
    - name: Permitir SSH en firewall
      win_firewall_rule:
        name: OpenSSH Server
        localport: 22
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes
    
    # ════════════════════════════════════════════════════════════
    # 5. Configurar servicios
    # ════════════════════════════════════════════════════════════
    
    - name: Asegurar que SSH está habilitado
      win_service:
        name: sshd
        state: started
        start_mode: auto
    
    # ════════════════════════════════════════════════════════════
    # 6. Instalar software básico (opcional)
    # ════════════════════════════════════════════════════════════
    
    - name: Verificar si winget está disponible
      win_shell: winget --version
      register: winget_check
      ignore_errors: yes
    
    - name: Instalar software con winget
      win_shell: |
        winget install --id {{ item }} --silent --accept-package-agreements --accept-source-agreements
      loop:
        - 7zip.7zip
        - VideoLAN.VLC
      when: winget_check.rc == 0
      ignore_errors: yes
    
    # ════════════════════════════════════════════════════════════
    # 7. Crear archivos de bienvenida
    # ════════════════════════════════════════════════════════════
    
    - name: Crear README para admin
      win_copy:
        content: |
          ════════════════════════════════════════════════════════════════
          Bienvenido a Windows 11 - GameCenter
          ════════════════════════════════════════════════════════════════
          
          Usuario: admin
          Rol: Administrador
          
          PERMISOS:
          ✅ Administrador completo
          ✅ Acceso SSH
          ✅ Gestión de usuarios
          ✅ Instalación de software
          
          CARPETAS:
          C:\Shared\Admin   - Tu carpeta personal
          C:\Shared\Audits  - Auditorías
          C:\Shared\Games   - Juegos compartidos
          
          CONECTAR POR SSH:
          Desde el servidor: ssh admin@[IPv6]
          
          ════════════════════════════════════════════════════════════════
        dest: C:\Users\admin\Desktop\README.txt
    
    - name: Crear README para auditor
      win_copy:
        content: |
          ════════════════════════════════════════════════════════════════
          Bienvenido a Windows 11 - GameCenter
          ════════════════════════════════════════════════════════════════
          
          Usuario: auditor
          Rol: Auditor
          
          PERMISOS:
          ✅ Ver logs del sistema
          ✅ Ver eventos
          ❌ NO puede instalar software
          ❌ NO tiene acceso SSH
          
          CARPETAS:
          C:\Shared\Audits  - Tu carpeta de auditorías
          
          VER LOGS:
          - Visor de eventos (Event Viewer)
          - Administrador de tareas
          
          ════════════════════════════════════════════════════════════════
        dest: C:\Users\auditor\Desktop\README.txt
      when: "'auditor' in windows_users | map(attribute='name')"
    
    - name: Crear README para gamer01
      win_copy:
        content: |
          ════════════════════════════════════════════════════════════════
          Bienvenido a Windows 11 - GameCenter
          ════════════════════════════════════════════════════════════════
          
          Usuario: gamer01
          Rol: Gamer
          
          PERMISOS:
          ✅ Jugar juegos
          ✅ Usar aplicaciones
          ❌ NO puede instalar software (pedir a admin)
          ❌ NO tiene acceso SSH
          
          CARPETAS:
          C:\Shared\Games  - Juegos compartidos
          
          JUEGOS:
          - Steam (si está instalado)
          - Epic Games
          - Minecraft
          
          ════════════════════════════════════════════════════════════════
        dest: C:\Users\gamer01\Desktop\README.txt
      when: "'gamer01' in windows_users | map(attribute='name')"

  # ════════════════════════════════════════════════════════════
  # Resumen final
  # ════════════════════════════════════════════════════════════
  
  post_tasks:
    - name: Mostrar resumen
      debug:
        msg: |
          ════════════════════════════════════════════════════════════════
          ✅ VM Windows 11 configurada exitosamente
          ════════════════════════════════════════════════════════════════
          
          VM: {{ inventory_hostname }}
          IPv6: {{ ansible_default_ipv6.address | default('Configurar manualmente') }}
          
          USUARIOS CREADOS:
          {% for user in windows_users %}
          - {{ user.name }} ({{ user.password }}) - {{ user.description }}
          {% endfor %}
          
          CONECTAR POR SSH:
          ssh admin@{{ ansible_default_ipv6.address | default('[IPv6]') }}
          
          ════════════════════════════════════════════════════════════════

