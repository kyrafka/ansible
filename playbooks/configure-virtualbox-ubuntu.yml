---
# Playbook para configurar VM Ubuntu Desktop en VirtualBox
- name: Configurar Ubuntu Desktop en VirtualBox
  hosts: virtualbox_vms
  become: yes
  gather_facts: yes
  
  vars:
    users:
      - name: administrador
        password: "123"
        groups: ["sudo", "adm"]
        shell: /bin/bash
        comment: "Administrador"
      
      - name: auditor
        password: "123456"
        groups: ["adm"]
        shell: /bin/bash
        comment: "Auditor - Solo lectura"
      
      - name: gamer01
        password: "123456"
        groups: ["users"]
        shell: /bin/bash
        comment: "Usuario gamer"
  
  tasks:
    # ════════════════════════════════════════════════════════════
    # 1. Información del sistema
    # ════════════════════════════════════════════════════════════
    
    - name: Mostrar información del sistema
      debug:
        msg:
          - "Sistema: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Hostname: {{ ansible_hostname }}"
          - "IP: {{ ansible_default_ipv4.address }}"
    
    # ════════════════════════════════════════════════════════════
    # 2. Actualizar sistema
    # ════════════════════════════════════════════════════════════
    
    - name: Actualizar cache de apt
      apt:
        update_cache: yes
        cache_valid_time: 3600
    
    - name: Actualizar todos los paquetes
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
      when: false  # Cambiar a true si quieres actualizar
    
    # ════════════════════════════════════════════════════════════
    # 3. Instalar paquetes básicos
    # ════════════════════════════════════════════════════════════
    
    - name: Instalar paquetes básicos
      apt:
        name:
          - vim
          - git
          - curl
          - wget
          - htop
          - net-tools
          - openssh-server
          - ufw
        state: present
    
    # ════════════════════════════════════════════════════════════
    # 4. Crear usuarios
    # ════════════════════════════════════════════════════════════
    
    - name: Crear usuarios
      user:
        name: "{{ item.name }}"
        password: "{{ item.password | password_hash('sha512') }}"
        groups: "{{ item.groups }}"
        shell: "{{ item.shell }}"
        comment: "{{ item.comment }}"
        create_home: yes
        state: present
      loop: "{{ users }}"
      when: item.name != 'administrador'  # administrador ya existe
    
    - name: Actualizar contraseña de administrador
      user:
        name: administrador
        password: "{{ '123' | password_hash('sha512') }}"
        groups: ["sudo", "adm"]
    
    # ════════════════════════════════════════════════════════════
    # 5. Configurar sudo
    # ════════════════════════════════════════════════════════════
    
    - name: Configurar sudo sin contraseña para administrador
      lineinfile:
        path: /etc/sudoers.d/administrador
        line: "administrador ALL=(ALL) NOPASSWD:ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
    
    # ════════════════════════════════════════════════════════════
    # 6. Configurar SSH
    # ════════════════════════════════════════════════════════════
    
    - name: Configurar SSH para permitir solo administrador
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?AllowUsers'
        line: 'AllowUsers administrador'
        state: present
      notify: Reiniciar SSH
    
    - name: Habilitar autenticación por contraseña
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication yes'
        state: present
      notify: Reiniciar SSH
    
    # ════════════════════════════════════════════════════════════
    # 7. Configurar firewall
    # ════════════════════════════════════════════════════════════
    
    - name: Habilitar UFW
      ufw:
        state: enabled
        policy: deny
    
    - name: Permitir SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
    
    # ════════════════════════════════════════════════════════════
    # 8. Crear directorios de trabajo
    # ════════════════════════════════════════════════════════════
    
    - name: Crear directorios compartidos
      file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "/srv/admin", owner: "administrador", group: "administrador", mode: "0755" }
        - { path: "/srv/audits", owner: "auditor", group: "auditor", mode: "0755" }
        - { path: "/srv/games", owner: "gamer01", group: "users", mode: "0775" }
    
    # ════════════════════════════════════════════════════════════
    # 9. Crear archivos README
    # ════════════════════════════════════════════════════════════
    
    - name: Crear README para administrador
      copy:
        dest: /home/administrador/README.txt
        owner: administrador
        group: administrador
        mode: '0644'
        content: |
          ════════════════════════════════════════════════════════════════
          Bienvenido a Ubuntu Desktop - VirtualBox
          ════════════════════════════════════════════════════════════════
          
          Usuario: administrador
          Rol: Administrador
          
          PERMISOS:
          ✅ Sudo completo (sin contraseña)
          ✅ Acceso SSH
          ✅ Gestión del sistema
          
          CONECTAR POR SSH:
          Desde tu PC: ssh -p 2222 administrador@localhost
          
          DIRECTORIOS:
          /srv/admin   - Tu carpeta personal
          /srv/audits  - Auditorías
          /srv/games   - Juegos compartidos
          
          ════════════════════════════════════════════════════════════════
    
    - name: Crear README para auditor
      copy:
        dest: /home/auditor/README.txt
        owner: auditor
        group: auditor
        mode: '0644'
        content: |
          ════════════════════════════════════════════════════════════════
          Bienvenido a Ubuntu Desktop - VirtualBox
          ════════════════════════════════════════════════════════════════
          
          Usuario: auditor
          Rol: Auditor
          
          PERMISOS:
          ✅ Ver logs del sistema
          ❌ NO tiene sudo
          ❌ NO tiene acceso SSH
          
          COMANDOS ÚTILES:
          journalctl -n 50                    # Últimos 50 logs
          journalctl --since "1 hour ago"     # Última hora
          
          DIRECTORIO:
          /srv/audits  - Tu carpeta de auditorías
          
          ════════════════════════════════════════════════════════════════
    
    - name: Crear README para gamer01
      copy:
        dest: /home/gamer01/README.txt
        owner: gamer01
        group: users
        mode: '0644'
        content: |
          ════════════════════════════════════════════════════════════════
          Bienvenido a Ubuntu Desktop - VirtualBox
          ════════════════════════════════════════════════════════════════
          
          Usuario: gamer01
          Rol: Gamer
          
          PERMISOS:
          ✅ Usar aplicaciones
          ✅ Jugar juegos
          ❌ NO puede instalar software
          ❌ NO tiene acceso SSH
          
          DIRECTORIO:
          /srv/games  - Juegos compartidos
          
          ════════════════════════════════════════════════════════════════
  
  # ════════════════════════════════════════════════════════════
  # Handlers
  # ════════════════════════════════════════════════════════════
  
  handlers:
    - name: Reiniciar SSH
      service:
        name: ssh
        state: restarted
  
  # ════════════════════════════════════════════════════════════
  # Resumen final
  # ════════════════════════════════════════════════════════════
  
  post_tasks:
    - name: Mostrar resumen
      debug:
        msg:
          - "════════════════════════════════════════════════════════════════"
          - "✅ VM Ubuntu Desktop configurada exitosamente"
          - "════════════════════════════════════════════════════════════════"
          - ""
          - "USUARIOS CREADOS:"
          - "  - admin (123) - Administrador con sudo"
          - "  - auditor (123456) - Solo lectura de logs"
          - "  - gamer01 (123456) - Usuario estándar"
          - ""
          - "CONECTAR POR SSH:"
          - "  ssh -p 2222 admin@localhost"
          - ""
          - "════════════════════════════════════════════════════════════════"

