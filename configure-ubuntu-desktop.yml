---
# Playbook para configurar la VM Ubuntu Desktop con 3 usuarios
# Ejecutar desde el SERVIDOR hacia la VM
# Uso: ansible-playbook configure-ubuntu-desktop.yml

- name: Configurar VM Ubuntu Desktop con mÃºltiples usuarios
  hosts: ubuntu_desktop
  become: true
  gather_facts: true

  vars:
    # DefiniciÃ³n de usuarios y sus roles
    system_users:
      - name: admin
        comment: "Administrador del sistema"
        password: "{{ vault_ubuntu_desktop_admin_password }}"
        groups: [sudo, adm, pcgamers]
        shell: /bin/bash
        ssh_access: true
        sudo_nopasswd: true
        
      - name: auditor
        comment: "Auditor del sistema"
        password: "{{ vault_ubuntu_desktop_auditor_password }}"
        groups: [adm, pcgamers]
        shell: /bin/bash
        ssh_access: false
        sudo_nopasswd: false
        
      - name: gamer01
        comment: "Usuario gamer/cliente"
        password: "{{ vault_ubuntu_desktop_cliente_password }}"
        groups: [pcgamers]
        shell: /bin/bash
        ssh_access: false
        sudo_nopasswd: false

  tasks:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # INFORMACIÃ“N INICIAL
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ“‹ InformaciÃ³n de la VM"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ–¥ï¸  Configurando VM Ubuntu Desktop"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Hostname: {{ ansible_hostname }}"
          - "IP: {{ ansible_default_ipv6.address | default('No IPv6') }}"
          - "Usuario actual: {{ ansible_user }}"
          - ""
          - "Se crearÃ¡n/configurarÃ¡n 3 usuarios:"
          - "  1. admin    - Administrador (sudo completo)"
          - "  2. auditor  - Auditor (solo lectura)"
          - "  3. gamer01  - Cliente/Gamer (sin privilegios)"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ACTUALIZACIÃ“N DEL SISTEMA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ”„ Actualizar cachÃ© de APT"
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: "â¬†ï¸  Actualizar paquetes del sistema"
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # INSTALACIÃ“N DE PAQUETES BASE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ“¦ Instalar paquetes base"
      apt:
        name:
          - vim
          - curl
          - wget
          - git
          - net-tools
          - htop
          - tmux
          - openssh-server
          - nfs-common
          - python3-pip
          - whois  # Para mkpasswd
        state: present

    - name: "ğŸ® Instalar herramientas de gaming"
      apt:
        name:
          - steam-installer
          - wine
          - winetricks
          - gamemode
        state: present

    - name: "ğŸ› ï¸  Instalar herramientas de administraciÃ³n"
      apt:
        name:
          - ansible
          - sysstat
          - iotop
          - nethogs
          - auditd
          - aide
        state: present

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONFIGURACIÃ“N DE GRUPOS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ‘¥ Crear grupo pcgamers (GID 3000 - mismo que el servidor)"
      group:
        name: pcgamers
        state: present
        gid: 3000  # IMPORTANTE: Mismo GID que el servidor para NFS

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CREACIÃ“N Y CONFIGURACIÃ“N DE USUARIOS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ‘¤ Crear/actualizar usuarios del sistema"
      user:
        name: "{{ item.name }}"
        comment: "{{ item.comment }}"
        password: "{{ item.password | password_hash('sha512') }}"
        groups: "{{ item.groups }}"
        shell: "{{ item.shell }}"
        create_home: yes
        state: present
      loop: "{{ system_users }}"
      no_log: true  # No mostrar contraseÃ±as en logs

    - name: "ğŸ” Configurar sudo sin contraseÃ±a para admin"
      lineinfile:
        path: /etc/sudoers.d/admin
        line: "admin ALL=(ALL) NOPASSWD:ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: "ğŸ“ Crear directorio .ssh para usuarios"
      file:
        path: "/home/{{ item.name }}/.ssh"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0700'
      loop: "{{ system_users }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONFIGURACIÃ“N DE RED IPv6
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸŒ Configurar netplan para IPv6 DHCP"
      copy:
        dest: /etc/netplan/01-netcfg.yaml
        content: |
          network:
            version: 2
            ethernets:
              ens33:
                dhcp4: false
                dhcp6: true
                accept-ra: true
                nameservers:
                  addresses:
                    - 2025:db8:10::2
                  search:
                    - gamecenter.local
        owner: root
        group: root
        mode: '0644'
      notify: aplicar netplan

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONFIGURACIÃ“N DE SSH
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ” Configurar SSH"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop:
        - { regexp: '^PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication yes' }
        - { regexp: '^PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
      notify: reiniciar ssh

    - name: "ğŸ”’ Configurar AllowUsers en SSH (solo admin)"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^AllowUsers'
        line: 'AllowUsers admin'
        state: present
      notify: reiniciar ssh

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONFIGURACIÃ“N DE FIREWALL
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ”¥ Instalar UFW"
      apt:
        name: ufw
        state: present

    - name: "ğŸ”¥ Configurar reglas de firewall"
      community.general.ufw:
        rule: "{{ item.rule }}"
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { rule: allow, port: '22', proto: tcp }    # SSH
        - { rule: allow, port: '3389', proto: tcp }  # RDP
        - { rule: allow, port: '5900', proto: tcp }  # VNC

    - name: "ğŸ”¥ Habilitar UFW"
      community.general.ufw:
        state: enabled
        policy: deny

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # MONTAJE DE NFS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ“ Crear puntos de montaje NFS"
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: pcgamers
        mode: '0775'
      loop:
        - /mnt/games
        - /mnt/shared

    - name: "ğŸ“ Montar NFS - Juegos"
      mount:
        path: /mnt/games
        src: "[2025:db8:10::2]:/srv/nfs/games"
        fstype: nfs4
        opts: defaults
        state: mounted

    - name: "ğŸ“ Montar NFS - Compartido"
      mount:
        path: /mnt/shared
        src: "[2025:db8:10::2]:/srv/nfs/shared"
        fstype: nfs4
        opts: defaults
        state: mounted

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONFIGURACIÃ“N ESPECÃFICA POR USUARIO
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "ğŸ® Crear directorio de juegos para cada usuario"
      file:
        path: "/home/{{ item.name }}/Games"
        state: directory
        owner: "{{ item.name }}"
        group: pcgamers
        mode: '0755'
      loop: "{{ system_users }}"

    - name: "ğŸ”— Crear enlace simbÃ³lico a juegos compartidos"
      file:
        src: /mnt/games
        dest: "/home/{{ item.name }}/SharedGames"
        state: link
        owner: "{{ item.name }}"
        group: pcgamers
      loop: "{{ system_users }}"

    - name: "ğŸ“ Crear archivo de bienvenida para cada usuario"
      copy:
        dest: "/home/{{ item.name }}/LEEME.txt"
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Bienvenido a Ubuntu Desktop GameCenter
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Usuario: {{ item.name }}
          Rol: {{ item.comment }}
          
          {% if item.name == 'admin' %}
          PERMISOS:
          âœ… Acceso SSH al servidor
          âœ… Sudo completo (sin contraseÃ±a)
          âœ… Acceso a logs del sistema
          âœ… Puede instalar software
          âœ… Puede modificar configuraciones
          
          COMANDOS ÃšTILES:
          - Ver logs: sudo journalctl -f
          - Monitorear sistema: htop
          - Ver red: ip -6 addr show
          - SSH al servidor: ssh ubuntu@2025:db8:10::2
          
          {% elif item.name == 'auditor' %}
          PERMISOS:
          âœ… Acceso de lectura a logs
          âœ… Puede ver configuraciones
          âŒ NO puede modificar el sistema
          âŒ NO tiene acceso SSH al servidor
          âŒ NO puede usar sudo
          
          COMANDOS ÃšTILES:
          - Ver logs: journalctl -f (solo lectura)
          - Monitorear sistema: htop
          - Ver red: ip -6 addr show
          
          {% else %}
          PERMISOS:
          âœ… Puede jugar juegos
          âœ… Acceso a juegos compartidos
          âŒ NO puede modificar el sistema
          âŒ NO tiene acceso SSH al servidor
          âŒ NO puede usar sudo
          
          DIRECTORIOS:
          - Juegos locales: ~/Games
          - Juegos compartidos: ~/SharedGames (enlace a /mnt/games)
          - Archivos compartidos: /mnt/shared
          
          {% endif %}
          
          RED:
          - Servidor: 2025:db8:10::2
          - DNS: server.gamecenter.local
          - Dominio: gamecenter.local
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0644'
      loop: "{{ system_users }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # RESUMEN FINAL
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: "âœ… ConfiguraciÃ³n completada"
      debug:
        msg:
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… VM Ubuntu Desktop configurada exitosamente"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Hostname: {{ ansible_hostname }}"
          - "IP IPv6: {{ ansible_default_ipv6.address | default('Verificar con: ip -6 addr') }}"
          - ""
          - "USUARIOS CREADOS:"
          - ""
          - "1. admin"
          - "   - ContraseÃ±a: {{ vault_ubuntu_desktop_admin_password }}"
          - "   - Grupos: sudo, adm, pcgamers"
          - "   - SSH: âœ… Habilitado"
          - "   - Sudo: âœ… Sin contraseÃ±a"
          - ""
          - "2. auditor"
          - "   - ContraseÃ±a: {{ vault_ubuntu_desktop_auditor_password }}"
          - "   - Grupos: adm, pcgamers"
          - "   - SSH: âŒ Deshabilitado"
          - "   - Sudo: âŒ No"
          - ""
          - "3. gamer01"
          - "   - ContraseÃ±a: {{ vault_ubuntu_desktop_cliente_password }}"
          - "   - Grupos: pcgamers"
          - "   - SSH: âŒ Deshabilitado"
          - "   - Sudo: âŒ No"
          - ""
          - "SERVICIOS CONFIGURADOS:"
          - "  âœ… Red IPv6 con DHCP"
          - "  âœ… DNS: 2025:db8:10::2"
          - "  âœ… NFS montado en /mnt/games y /mnt/shared"
          - "  âœ… Firewall configurado"
          - "  âœ… SSH habilitado (solo admin)"
          - ""
          - "VERIFICAR:"
          - "  ping6 2025:db8:10::2        # Servidor"
          - "  ping6 google.com            # Internet"
          - "  ls /mnt/games               # NFS"
          - "  ssh admin@localhost         # SSH local"
          - ""
          - "INICIAR SESIÃ“N:"
          - "  - Cierra sesiÃ³n actual"
          - "  - Inicia con: admin, auditor o gamer01"
          - "  - Lee el archivo ~/LEEME.txt en cada usuario"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  handlers:
    - name: aplicar netplan
      command: netplan apply

    - name: reiniciar ssh
      systemd:
        name: ssh
        state: restarted
