---
# Playbook para probar templates Jinja2
- name: Probar generaciÃ³n de templates
  hosts: localhost
  connection: local
  gather_facts: true
  become: false
  
  vars:
    servicios_necesarios:
      - bind9
      - isc-dhcp-server6
      - fail2ban
    
    storage:
      dns_log_retention_days: 14
      dhcp_log_retention_days: 7
      security_log_retention_days: 30
    
    network_config:
      ipv6_network: "2025:db8:10::/64"
    
    vault_ubuntu_user: "ubuntu"
    vault_ubuntu_password: "ubuntu123"
    ssh_authorized_key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... test@example.com"
    
    test_dir: "/tmp/ansible-templates-{{ ansible_date_time.epoch }}"
  
  tasks:
    - name: Crear directorio de pruebas
      file:
        path: "{{ test_dir }}"
        state: directory
        mode: '0755'
    
    - name: Mostrar informaciÃ³n de la prueba
      debug:
        msg: |
          ğŸ§ª PRUEBA DE TEMPLATES JINJA2
          ğŸ“ Directorio: {{ test_dir }}
          ğŸ–¥ï¸ Sistema: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ“… Fecha: {{ ansible_date_time.iso8601 }}
    
    - name: Generar template de rsyslog
      template:
        src: roles/common/templates/rsyslog-proyecto.conf.j2
        dest: "{{ test_dir }}/rsyslog-proyecto.conf"
        mode: '0644'
      register: rsyslog_result
    
    - name: Generar template de logrotate
      template:
        src: roles/common/templates/logrotate-proyecto.conf.j2
        dest: "{{ test_dir }}/logrotate-proyecto.conf"
        mode: '0644'
      register: logrotate_result
      ignore_errors: true
    
    - name: Generar template de log-monitor
      template:
        src: roles/common/templates/log-monitor.sh.j2
        dest: "{{ test_dir }}/log-monitor.sh"
        mode: '0755'
      register: monitor_result
      ignore_errors: true
    
    - name: Generar template de user-data
      template:
        src: roles/vmware/templates/user-data.j2
        dest: "{{ test_dir }}/user-data.yml"
        mode: '0644'
      register: userdata_result
      ignore_errors: true
    
    - name: Mostrar resultados
      debug:
        msg: |
          ğŸ“Š RESULTADOS DE LA GENERACIÃ“N:
          
          âœ… rsyslog-proyecto.conf: {{ 'GENERADO' if rsyslog_result.changed else 'ERROR' }}
          {{ 'âœ…' if logrotate_result.changed else 'âŒ' }} logrotate-proyecto.conf: {{ 'GENERADO' if logrotate_result.changed else 'ERROR' }}
          {{ 'âœ…' if monitor_result.changed else 'âŒ' }} log-monitor.sh: {{ 'GENERADO' if monitor_result.changed else 'ERROR' }}
          {{ 'âœ…' if userdata_result.changed else 'âŒ' }} user-data.yml: {{ 'GENERADO' if userdata_result.changed else 'ERROR' }}
          
          ğŸ“ Archivos generados en: {{ test_dir }}
    
    - name: Mostrar contenido de rsyslog generado
      debug:
        msg: |
          ğŸ“„ CONTENIDO DE RSYSLOG (primeras lÃ­neas):
          {{ lookup('file', test_dir + '/rsyslog-proyecto.conf').split('\n')[:10] | join('\n') }}
      when: rsyslog_result.changed
    
    - name: Listar archivos generados
      find:
        paths: "{{ test_dir }}"
        file_type: file
      register: generated_files
    
    - name: Mostrar archivos generados
      debug:
        msg: |
          ğŸ“‹ ARCHIVOS GENERADOS:
          {% for file in generated_files.files %}
          - {{ file.path | basename }} ({{ file.size }} bytes)
          {% endfor %}
          
          ğŸ§¹ Para limpiar: rm -rf {{ test_dir }}